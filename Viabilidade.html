<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dimensionamento de Reservação • Verificação</title>
<style>
  :root{
    --brand:#17E3CB; --brand-deep:#10bfa9;
    --ink:#111799; --muted:#3d47b5; --line:#8beee3;
    --ok:#22c55e; --bad:#ef4444; --warn:#b45309;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 90% -10%, rgba(23,227,203,.25), rgba(23,227,203,0) 60%),
      radial-gradient(800px 520px at 8% 0%, rgba(23,227,203,.35), rgba(23,227,203,0) 55%),
      linear-gradient(180deg, #20f0d8 0%, #17E3CB 45%, #14d1bb 70%, #10bfa9 100%);
    color:var(--ink);
    font:500 16px/1.5 system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial
  }

  header{
    display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap;
    padding:12px 16px;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(23,227,203,.45), rgba(23,227,203,.20));
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(4px);
  }
  .brand-text{font-size:20px;font-weight:900;letter-spacing:.25rem;text-transform:uppercase;color:var(--ink)}

  .wrap{max-width:1180px;margin:20px auto 32px;padding:0 16px}
  h1{font-size:1.55rem;margin:.6rem 0 .25rem;color:var(--ink);text-align:center}
  .sub{color:var(--muted);text-align:center}

  /* Abas (Tabs) */
  .tab-nav{display:flex;justify-content:center;gap:10px;margin-bottom:16px;padding:8px;border-radius:10px;background:rgba(255,255,255,.55);border:1px solid var(--line)}
  .tab-nav button{background:transparent;border:none;color:var(--ink);font-weight:700;padding:8px 15px;border-radius:8px;transition:background .2s}
  .tab-nav button.active{background:var(--brand);color:#083a35;box-shadow:0 3px 6px rgba(0,0,0,.1)}
  .tab-content > div{display:none}
  .tab-content > div.active{display:block}

  /* Layout 2 colunas */
  .layout-2col{
    display:grid; gap:16px; grid-template-columns:1fr; align-items:start; margin-top:14px;
  }
  @media (min-width:1024px){ .layout-2col{ grid-template-columns:5fr 7fr } }
  .col > .card{ margin:0 0 16px }

  /* Cards/UI */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.45));
    border:1px solid var(--line); border-radius:14px; padding:16px;
    box-shadow:0 10px 24px rgba(17,23,153,.08), inset 0 1px 0 rgba(255,255,255,.65);
  }
  h2{margin:0 0 10px;font-size:1.05rem;color:var(--ink)}
  label{display:block;font-size:.92rem;color:var(--muted);margin:8px 0 6px}
  input[type="number"],input[type="text"],input[type="date"],select{
    width:100%;padding:10px 12px;border-radius:10px;background:#fff;border:1px solid var(--line);color:var(--ink);outline:none;
    transition:border-color .2s, box-shadow .2s, background .2s
  }
  input::placeholder{color:#6f78d0}
  input:focus,select:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(23,227,203,.25); background:#fff }
  .row3{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:end}

  .kpi{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#ffffffd9;border:1px solid var(--line);border-radius:10px;margin:8px 0;color:var(--ink)}
  .kpi .val{font-weight:800}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .note{font-size:.9rem;color:#555}

  .alert{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid rgba(245,158,11,.35);border-radius:10px;background:rgba(245,158,11,.08);color:#9a6f00;margin:8px 0}
  .banner{display:none;margin:12px 0 0;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg, rgba(23,227,203,.18), rgba(255,255,255,.6));border:1px dashed var(--brand); color:#0e2a27; font-weight:800; text-align:center}
  .banner.show{display:block}

  /* Conclusão */
  .conclusao .head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;font-size:.85rem;letter-spacing:.02rem}
  .pill.ok{background:rgba(34,197,94,.12);color:#166534;border:1px solid rgba(34,197,94,.35)}
  .pill.bad{background:rgba(239,68,68,.12);color:#991b1b;border:1px solid rgba(239,68,68,.35)}
  .pill.warn{background:rgba(180,83,9,.12);color:#7c2d12;border:1px solid rgba(180,83,9,.35)}
  .lead{margin:.35rem 0 .2rem;font-weight:900;color:#0b3834}
  .lead big{font-size:1.35rem;font-variant-numeric:tabular-nums}
  .conclusao ul{margin:.4rem 0 .2rem 1.1rem}
  .conclusao .note{margin-top:8px}

  /* Botões */
  .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
  button{
    cursor:pointer;border-radius:10px;padding:10px 14px;border:1px solid var(--brand-deep);
    background:linear-gradient(180deg, var(--brand), var(--brand-deep)); color:#083a35;font-weight:800;letter-spacing:.2px;
    box-shadow:0 8px 16px rgba(0,0,0,.08); transition:transform .05s ease-out, filter .15s ease-out
  }
  button:hover{ filter:brightness(1.03) saturate(1.05) }
  button:active{ transform:translateY(1px) }
  button.secondary{ background:linear-gradient(180deg, rgba(23,227,203,.25), rgba(23,227,203,.12)); border-color:var(--line); color:var(--ink); font-weight:700 }
  button.save-btn{ background:linear-gradient(180deg, #22c55e, #16a34a); border-color:#16a34a; color:#fff }

  .foot{font-size:.9rem;color:var(--muted);text-align:center;margin-top:10px}
  footer{margin:18px 0 10px;text-align:center;color:var(--muted);font-size:.95rem}

  /* Tabela de Histórico (Pivotada) */
  .table-container{overflow-x:auto}
  .history-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.85rem;min-width:1400px}
  .history-table th,.history-table td{border:1px solid #ddd;padding:6px 8px;text-align:left;white-space:nowrap}
  .history-table th:first-child{background:#f0fbfb;color:#0e2a27;font-weight:700}
  .history-table th:not(:first-child){background:#f9fdfd;color:#111;text-align:center}
  .history-table td:first-child{font-weight:700;color:var(--ink)}
  .history-table .load-btn{padding:4px 8px;font-size:.8rem;background:#5b21b6;color:#fff;border:1px solid #4c1d95;cursor:pointer;border-radius:6px}
  .history-table .secondary{background:#d4d4d4;color:#444;border-color:#a3a3a3}
  .action-cell{display:flex;gap:4px;justify-content:center;align-items:center}
</style>
</head>
<body onload="carregarHistorico()">
  <header>
    <div class="brand-text">AEGEA</div>
  </header>

  <div class="wrap">
    <h1>Dimensionamento de Reservação <span class="sub" id="critTag">• critério 1/5</span></h1>
    <p class="sub">Verificação de reservação com dados de sistema existente e do novo empreendimento.</p>

    <div class="tab-nav">
        <button id="tabCalcBtn" class="active">Cálculo e Verificação</button>
        <button id="tabHistoryBtn">Histórico de Empreendimentos (<span id="historyCount">0</span>)</button>
    </div>

    <div class="tab-content">
        <div id="tabCalculo" class="active">
            <div id="bannerObrigatorio" class="banner">Novo reservatório <b>obrigatório</b> para o empreendimento (Nº de economias <b>≥ 120</b>).</div>

            <div class="layout-2col">
            <div class="col left">
                <section class="card">
                <h2>Dados do Projeto e Modelo</h2>
                <label for="nomeProjeto">Nome do Projeto</label>
                <input id="nomeProjeto" type="text" placeholder="Ex.: Residencial Sol Nascente" />

                <label for="software">Software Utilizado</label>
                <input id="software" type="text" placeholder="Ex.: WaterGems, EPANET, EPANET JS" />
                
                <label for="modeloBase">Modelo Base Utilizado</label>
                <input id="modeloBase" type="text" placeholder="Ex.: RSOL-V01, Modelo Calibrado 2024" />

                <label for="dataCalibracao">Data da Calibração do Modelo</label>
                <input id="dataCalibracao" type="date" />
                </section>
                
                <section class="card">
                <h2>Sistema existente</h2>
                <label for="volExist">Reservação existente (m³)</label>
                <input id="volExist" type="number" min="0" step="0.01" placeholder="Ex.: 50" />

                <label>Demanda + Perdas existente</label>
                <div class="row3">
                    <input id="qExist" type="number" min="0" step="0.001" placeholder="Valor (ex.: 12)" />
                    <select id="uExist" aria-label="Unidade da demanda existente">
                    <option value="lps">L/s</option>
                    <option value="m3h">m³/h</option>
                    </select>
                    <div></div>
                </div>

                <div class="hr"></div>
                <div class="kpi">
                    <span class="muted">Demanda diária existente</span>
                    <span class="val" id="kpiExistM3d">—</span>
                </div>
                </section>

                <section id="conclusaoCard" class="conclusao card" style="display:none;">
                <div class="head">
                    <h3 style="margin:0">Conclusão / Resultado final</h3>
                    <span id="pillStatus" class="pill">—</span>
                </div>
                <div id="conclusaoLead" class="lead"></div>
                <div id="conclusaoText">—</div>

                <div class="btns" id="acoesConclusao">
                    <button class="secondary" id="btnClear">Limpar</button>
                    <button id="btnSalvarEmp" class="save-btn">Salvar Empreendimento</button>
                    <button id="btnRelatorio">Gerar Memorial de Cálculo</button>
                </div>
                <div class="foot">Observações: verificação por critério selecionado (<b><span class="crit-span">1/5</span></b> ou <b>1/3</b>). Avalie também reserva para incêndio e normas locais.</div>
                </section>
            </div>

            <div class="col right">
                <section class="card">
                <h2>Empreendimento (para calcular a demanda)</h2>

                <label for="criterio">Critério de reservação</label>
                <select id="criterio" aria-label="Critério de reservação">
                    <option value="5" selected>1/5 (padrão)</option>
                    <option value="3">1/3</option>
                </select>

                <label for="economias">Número de economias</label>
                <input id="economias" type="number" min="0" step="1" placeholder="Ex.: 150" />

                <label for="habEcon">Habitantes por economia <span class="muted">(padrão 3)</span></label>
                <input id="habEcon" type="number" min="0" step="0.01" value="3" />

                <label for="pcd">Consumo per capita (L/hab·dia) <span class="muted">(padrão 150)</span></label>
                <input id="pcd" type="number" min="0" step="1" value="150" />

                <label for="kdmc">KDMC – dia de maior consumo <span class="muted">(padrão 1,2)</span></label>
                <input id="kdmc" type="number" min="0" step="0.01" value="1.2" />
                
                <label for="perdasPct">Perdas (%) da demanda <span class="muted">(padrão 30%)</span></label>
                <input id="perdasPct" type="number" min="0" step="1" value="30" placeholder="Ex.: 30" />

                <label for="empUnit">Unidade para exibição da demanda do empreendimento</label>
                <select id="empUnit" aria-label="Unidade de exibição da demanda do empreendimento">
                    <option value="m3d" selected>m³/dia (padrão)</option>
                    <option value="m3h">m³/h</option>
                    <option value="ls">L/s</option>
                    <option value="ld">L/dia</option>
                </select>

                <div class="hr"></div>
                <div class="kpi">
                    <span class="muted">Demanda do empreendimento (exibição)</span>
                    <span class="val" id="kpiEmp">—</span>
                </div>
                <p class="note">O cálculo interno é feito em L/dia ➜ m³/dia. A unidade acima altera apenas a <b>exibição</b>. A demanda já inclui as perdas (%).</p>
                </section>

                <section class="card">
                <h2>Resultados</h2>

                <div class="kpi">
                    <span class="muted">Reservação necessária – EXISTENTE (<span class="crit-span">1/5</span>)</span>
                    <span class="val" id="kpiNecExist">—</span>
                </div>

                <div class="kpi">
                    <span class="muted">Reservação necessária – EMPREENDIMENTO (<span class="crit-span">1/5</span>)</span>
                    <span class="val" id="kpiNecEmp">—</span>
                </div>

                <div class="kpi" id="rowNecTotal">
                    <span class="muted">Reservação necessária – TOTAL (<span class="crit-span">1/5</span>)</span>
                    <span class="val" id="kpiNecTotal">—</span>
                </div>

                <div class="kpi">
                    <span class="muted">Reservatório existente</span>
                    <span class="val" id="kpiExistVol">—</span>
                </div>

                <div class="kpi" id="sitBox">
                    <span class="muted">Situação</span>
                    <span class="val" id="kpiSit">—</span>
                </div>

                <div class="kpi" id="defBox" style="display:none;">
                    <span class="muted">Déficit (total vs. existente)</span>
                    <span class="val bad" id="kpiDef">—</span>
                </div>

                <div class="kpi" id="supBox" style="display:none;">
                    <span class="muted">Superávit (total vs. existente)</span>
                    <span class="val ok" id="kpiSup">—</span>
                </div>
                </section>

                <section id="abaDim" class="card" hidden>
                <h2>Dimensionamento da Reservação do Empreendimento</h2>
                <p class="sub">
                    O novo reservatório é dimensionado com base em <b><span class="crit-span">1/5</span> da demanda diária do empreendimento</b>.
                </p>

                <div id="warnExistente" class="alert" style="display:none;">
                   ⚠️ Atenção: o reservatório existente <b>não atende a demanda atual</b> (sem o empreendimento).
                    Dimensionar somente o reservatório do empreendimento <b>não regulariza</b> o sistema existente.
                </div>

                <div class="hr"></div>
                <div class="kpi">
                    <span class="muted">Volume de Cálculo Alvo (Valor Real)</span>
                    <span class="val" id="dimAlvoEmp">—</span>
                </div>
                <div class="kpi">
                    <span class="muted">Demanda do empreendimento</span>
                    <span class="val" id="dimDemEmp">—</span>
                </div>
                </section>
            </div>
            </div>
        </div>

        <div id="tabHistorico">
            <h2>Histórico e Comparativo de Empreendimentos</h2>
            <p class="sub">Cada coluna (exceto a primeira) representa um empreendimento salvo. Use os botões no final de cada coluna para ações.</p>
            <div class="btns">
                <button id="btnCopyTable">Copiar Tabela (Planilha)</button>
                <button id="btnExportCSV" class="secondary">Exportar Tabela (CSV)</button>
                <button class="secondary" onclick="exportarHistorico()">Exportar Backup (JSON)</button>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importarHistorico(event)" />
                <button class="secondary" onclick="document.getElementById('importFile').click()">Importar Backup (JSON)</button>
                <button class="secondary" onclick="limparHistorico()">Limpar Todo o Histórico</button>
            </div>
            <div class="table-container">
                <table id="historyTable" class="history-table">
                    </table>
            </div>
            <p class="note" style="margin-top:16px;">Os dados são salvos no seu navegador (Local Storage).</p>
        </div>
    </div>

    <footer>Desenvolvido por <b>kelvin zeferino de souza</b></footer>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const fmt = (x, unit) => (isFinite(x) ? `${x.toLocaleString('pt-BR',{maximumFractionDigits:2})} ${unit}` : '—');
  const fmtNum = x => isFinite(x) ? x.toLocaleString('pt-BR',{maximumFractionDigits:2}) : ''; 
  const fmtCSV = x => isFinite(x) ? x.toFixed(3).replace('.', ',') : (typeof x === 'string' ? `"${String(x).replace(/"/g, '""')}"` : ''); 

  // Parser robusto
  function num(val) {
    if (typeof val === 'number') return isFinite(val) ? val : 0;
    if (val === null || val === undefined) return 0;
    let s = String(val).trim();
    if (s === '') return 0;
    if (s.includes('.') && s.includes(',')) { s = s.replace(/\./g,'').replace(',', '.'); }
    else if (s.includes(',')) { s = s.replace(',', '.'); }
    const n = parseFloat(s);
    return isNaN(n) || n < 0 ? 0 : n;
  }
  
  const txt = id => $(id).value.trim();

  // Conversões base
  const lpsToM3d = q => q * 86.4;     
  const m3hToM3d = q => q * 24;       
  
  const LOCAL_STORAGE_KEY = 'reservacaoHistorico';

  // Estado (mantém os valores do último cálculo)
  let last = {
    // Campos de projeto
    nomeProjeto:'', software:'', modeloBase:'', dataCalibracao:'',
    // Entradas
    volExist:0, qExist:0, uExist:'lps',
    economias:0, habEcon:3, pcd:150, kdmc:1.2, perdasPct:30,
    critDen:5, 
    empUnit:'m3d',
    // Cálculos Intermediários
    demandaBaseLd: 0, 
    vazaoMediaM3d: 0, 
    consumoMaxDiarioM3d: 0, 
    demandaPerdaM3d: 0, 
    // Resultados
    demExistM3d:0, demEmpLd:0, demEmpM3d:0, demEmpM3h:0, demEmpLs:0,
    necExist:0, necEmp:0, necTotal:0,
    atendeTotal:false, deficitTotal:0, superavitTotal:0,
    recomendaEmp:0, // Valor real
    alvoEmp:0, // Valor real
    existAtendeAtual:true,
    obrigatorio:false,
    timestamp: null
  };
  
  let historyData = []; 

  const critText = () => (last.critDen === 3 ? '1/3' : '1/5');

  function atualizarCritRotulos(){
    document.querySelectorAll('.crit-span').forEach(el => el.textContent = critText());
    const tag = $('critTag');
    if (tag) tag.textContent = '• critério ' + critText();
  }

  function atualizarKpiEmp(){
    const unit = last.empUnit;
    if (unit === 'm3d'){
      $('kpiEmp').textContent = last.demEmpM3d > 0 ? fmt(last.demEmpM3d,'m³/dia') : '—';
    } else if (unit === 'm3h'){
      $('kpiEmp').textContent = last.demEmpM3h > 0 ? fmt(last.demEmpM3h,'m³/h') : '—';
    } else if (unit === 'ls'){
      $('kpiEmp').textContent = last.demEmpLs > 0 ? fmt(last.demEmpLs,'L/s') : '—';
    } else {
      $('kpiEmp').textContent = last.demEmpLd > 0 ? fmt(last.demEmpLd,'L/dia') : '—';
    }
  }

  function aplicarObrigatoriedadeUI(obrigatorio){
    $('bannerObrigatorio').classList.toggle('show', obrigatorio);
    $('sitBox').style.display = obrigatorio ? 'none' : 'flex';
    $('defBox').style.display = 'none';
    $('supBox').style.display = 'none';
  }

  // Conclusão (HTML + status)
  function conclusaoHTML(){
    const hasInputs = last.volExist > 0 || last.economias > 0;
    if (!hasInputs) return { html:'Informe dados para calcular a situação e a recomendação final.', lead:'', show:false, status:'neutral', statusText:'—' };

    const fVolExist = fmt(last.volExist,'m³');
    const fNecTotal = fmt(last.necTotal,'m³');
    const fSup      = fmt(last.superavitTotal,'m³');
    const fDef      = fmt(last.deficitTotal,'m³');
    const fAlvoEmp  = fmt(last.alvoEmp,'m³');
    const fRecomEmp = fmt(last.recomendaEmp,'m³'); 
    const cTxt      = critText();

    const avisoExistente = last.existAtendeAtual
      ? ''
      : `<div class="note"><b>Atenção:</b> o reservatório existente <u>não atende</u> a demanda atual (sem o empreendimento). Dimensionar somente o reservatório do empreendimento <u>não regulariza</u> o sistema existente.</div>`;

    if (last.obrigatorio){
      const lead = `Novo reservatório do empreendimento recomendado: <big>${fRecomEmp}</big>`;
      const html = `
        <ul>
          <li><b>Regra:</b> Nº de economias ≥ 120 ⇒ <b>OBRIGATÓRIO</b> novo reservatório</li>
          <li><b>Alvo (${cTxt} da demanda do empreendimento):</b> ${fAlvoEmp}</li>
        </ul>
        ${avisoExistente}
      `;
      return { html, lead, show:true, status:'warn', statusText:'OBRIGATÓRIO' };
    }

    if (last.atendeTotal){
      const lead = `Atende ao critério ${cTxt} • Superávit: <big>${fSup}</big>`;
      const html = `
        <ul>
          <li><b>Reservatório existente:</b> ${fVolExist}</li>
          <li><b>Necessária total (${cTxt}):</b> ${fNecTotal}</li>
        </ul>
        <div class="note">Não é necessário novo reservatório para o empreendimento pelo critério ${cTxt}.</div>
      `;
      return { html, lead, show:true, status:'ok', statusText:'ADEQUADO' };
    }

    const lead = `Recomendado para o empreendimento: <big>${fRecomEmp}</big>`;
    const html = `
      <ul>
        <li><b>Reservatório existente:</b> ${fVolExist}</li>
        <li><b>Necessária total (${cTxt}):</b> ${fNecTotal}</li>
        <li><b>Déficit (vs. total):</b> ${fDef}</li>
      </ul>
      <div><b>Recomendação:</b> implantar novo reservatório do empreendimento com <b>${fAlvoEmp}</b> (${cTxt} do empreendimento).</div>
      ${avisoExistente}
    `;
    return { html, lead, show:true, status:'bad', statusText:'INSUFICIENTE' };
  }

  function calcular() {
    // 1. Captura de Entradas
    const nomeProjeto = txt('nomeProjeto');
    const software = txt('software');
    const modeloBase = txt('modeloBase');
    const dataCalibracao = txt('dataCalibracao');
    
    const volExist = num($('volExist').value);
    const qExist   = num($('qExist').value);
    const uExist   = $('uExist').value;

    let demExistM3d = 0;
    if (qExist > 0) demExistM3d = (uExist === 'lps') ? lpsToM3d(qExist) : m3hToM3d(qExist);

    const economias = num($('economias').value);
    const habEcon   = num($('habEcon').value) || 3;
    const pcd       = num($('pcd').value)     || 150;
    const kdmc      = num($('kdmc').value)    || 1.2;
    const perdasPct = num($('perdasPct').value) || 30;
    const critDen = parseInt($('criterio').value,10) || 5;
    const empUnit = $('empUnit').value;

    // 2. Cálculos Detalhados
    const consumoMaxDiarioLd = economias * habEcon * pcd * kdmc;
    const consumoMaxDiarioM3d = consumoMaxDiarioLd / 1000;
    
    const demandaBaseLd = economias * habEcon * pcd;
    const vazaoMediaM3d = demandaBaseLd / 1000; 

    const fatorPerda = 1 + (perdasPct / (100 - perdasPct));
    
    const demEmpLd  = consumoMaxDiarioLd * fatorPerda;
    
    const demEmpM3d = demEmpLd / 1000;         
    const demEmpM3h = demEmpM3d / 24;          
    const demEmpLs  = demEmpLd / 86400; 
    
    const demandaPerdaM3d = demEmpM3d - consumoMaxDiarioM3d;

    const necExist  = demExistM3d / critDen;
    const necEmp    = demEmpM3d   / critDen;
    const necTotal  = (demExistM3d + demEmpM3d) / critDen;

    const atendeTotal   = volExist >= necTotal;
    const deficitTotal  = Math.max(0, necTotal - volExist);
    const superavitTot  = Math.max(0, volExist - necTotal);
    const existAtendeAtual = volExist >= necExist;
    const obrigatorio = economias >= 120;

    const alvoEmp = necEmp;
    const recomendaEmp = alvoEmp;

    // 3. Atualiza o Estado (last)
    Object.assign(last, {
      nomeProjeto, software, modeloBase, dataCalibracao, 
      volExist, qExist, uExist,
      economias, habEcon, pcd, kdmc, perdasPct, critDen, empUnit,
      // Novos cálculos
      vazaoMediaM3d, consumoMaxDiarioM3d, demandaPerdaM3d, demandaBaseLd, 
      // Resultados
      demExistM3d, demEmpLd, demEmpM3d, demEmpM3h, demEmpLs,
      necExist, necEmp, necTotal,
      atendeTotal, deficitTotal, superavitTotal: superavitTot,
      recomendaEmp, // Valor exato
      alvoEmp, // Valor exato
      existAtendeAtual,
      obrigatorio,
      timestamp: last.timestamp || new Date().getTime()
    });

    // 4. Atualiza a UI (KPIs e Conclusão)
    $('kpiExistM3d').textContent = demExistM3d > 0 ? fmt(demExistM3d,'m³/dia') : '—';
    $('kpiNecExist').textContent = necExist > 0 ? fmt(necExist,'m³') : '—';
    $('kpiNecEmp').textContent   = necEmp   > 0 ? fmt(necEmp,'m³')   : '—';
    $('kpiNecTotal').textContent = necTotal > 0 ? fmt(necTotal,'m³') : '—';
    $('kpiExistVol').textContent = volExist > 0 ? fmt(volExist,'m³') : '—';

    atualizarCritRotulos();
    atualizarKpiEmp();
    aplicarObrigatoriedadeUI(obrigatorio);

    const abaDim = $('abaDim');
    const sit = $('kpiSit'); 
    
    if (obrigatorio || !atendeTotal) {
      abaDim.hidden = false;
      $('dimAlvoEmp').textContent = fmt(alvoEmp, 'm³'); 
      $('dimDemEmp').textContent = `${fmt(demEmpM3d,'m³/dia')} • ${fmt(demEmpM3h,'m³/h')} • ${fmt(demEmpLs,'L/s')} • ${fmt(demEmpLd,'L/dia')}`;
      $('warnExistente').style.display = existAtendeAtual ? 'none' : 'block';
    } else {
      abaDim.hidden = true;
    }

    if (necTotal <= 0 && volExist <= 0) {
      sit.textContent = '—'; sit.className = 'val';
    } else if (obrigatorio) {
       sit.textContent = '—'; sit.className = 'val';
    } else if (atendeTotal) {
      sit.textContent = `Adequado (≥ ${critText()})`; sit.className = 'val ok';
      $('supBox').style.display = 'flex'; $('kpiSup').textContent = fmt(superavitTot,'m³');
      $('defBox').style.display = 'none';
    } else {
      sit.textContent = `Insuficiente (< ${critText()})`; sit.className = 'val bad';
      $('defBox').style.display = 'flex'; $('kpiDef').textContent = fmt(deficitTotal,'m³');
      $('supBox').style.display = 'none';
    }

    const concl = conclusaoHTML();
    $('conclusaoLead').innerHTML = concl.lead || '';
    $('conclusaoText').innerHTML = concl.html;
    $('conclusaoCard').style.display = concl.show ? 'block' : 'none';

    const pill = $('pillStatus');
    pill.textContent = concl.statusText || '—';
    pill.className = 'pill ' + (concl.status === 'ok' ? 'ok' : concl.status === 'bad' ? 'bad' : concl.status === 'warn' ? 'warn' : '');
  }

  // ==========================================================
  // FUNÇÕES DE HISTÓRICO E ARMAZENAMENTO
  // ==========================================================
  
  function salvarHistorico() {
    try {
        const dataToSave = historyData.map(item => {
            if (item.dataCalibracao && item.dataCalibracao.includes('T00:00:00')) {
                 item.dataCalibracao = item.dataCalibracao.split('T')[0];
            }
            return item;
        });
        
        const json = JSON.stringify(dataToSave);
        localStorage.setItem(LOCAL_STORAGE_KEY, json);
    } catch (e) {
        alert('Erro ao salvar o histórico no navegador: ' + e.message);
    }
  }

  function carregarHistorico() {
    try {
        const json = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (json) {
            historyData = JSON.parse(json);
        } else {
            historyData = [];
        }
        renderizarTabelaHistorico();
    } catch (e) {
        alert('Erro ao carregar o histórico: ' + e.message);
        historyData = []; 
    }
  }

  window.limparHistorico = function() {
    if (confirm('Tem certeza que deseja APAGAR todo o histórico de empreendimentos salvos? Esta ação é irreversível.')) {
        historyData = [];
        salvarHistorico();
        renderizarTabelaHistorico();
    }
  }
  
  // --- FUNÇÃO PARA RENDERIZAR TABELA PIVOTADA ---
  function renderizarTabelaHistorico() {
    const table = $('historyTable');
    table.innerHTML = ''; 
    
    $('historyCount').textContent = historyData.length;

    if (historyData.length === 0) {
        table.innerHTML = '<tbody><tr><td colspan="2" style="text-align:center; color:#555;">Nenhum empreendimento salvo ainda.</td></tr></tbody>';
        return;
    }

    // 1. Definir as Métricas (Linhas)
    const metrics = [
        { key: 'nomeProjeto', title: 'Nome do Projeto', format: 'text' },
        { key: 'software', title: 'Software Utilizado', format: 'text' },
        { key: 'modeloBase', title: 'Modelo Base Utilizado', format: 'text' },
        { key: 'dataCalibracao', title: 'Data da Calibração', format: 'date' },
        { key: 'spacer1', title: ' ', format: 'text' },
        { key: 'economias', title: 'Nº de Economias', format: 'number' },
        { key: 'habEcon', title: 'Habitantes por Economia', format: 'number' },
        { key: 'pcd', title: 'Consumo Per capita (L/hab·dia)', format: 'number' },
        { key: 'kdmc', title: 'KDMC', format: 'number' },
        { key: 'perdasPct', title: 'Perdas (%) da Demanda', format: 'percent' },
        { key: 'spacer2', title: ' ', format: 'text' },
        { key: 'vazaoMediaM3d', title: 'Vazão Média (m³/dia)', format: 'number' },
        { key: 'consumoMaxDiarioM3d', title: 'Consumo Dia de Maior Consumo (m³/dia)', format: 'number' },
        { key: 'demandaPerdaM3d', title: 'Demanda de Perda (m³/dia)', format: 'number' },
        { key: 'demEmpM3d', title: 'Demanda Total do Empreendimento (m³/dia)', format: 'number' },
        { key: 'spacer3', title: ' ', format: 'text' },
        { key: 'critDen', title: 'Critério de Reservação', format: 'crit' },
        { key: 'necEmp', title: 'Reservação Necessária (m³)', format: 'number' },
        { key: 'recomendaEmp', title: 'Volume Recomendado (Valor Real) (m³)', format: 'number' },
        { key: 'spacer4', title: ' ', format: 'text' },
        { key: 'atendeTotal', title: 'Situação', format: 'status' },
        { key: 'deficitTotal', title: 'Déficit Total (m³)', format: 'deficit' },
        { key: 'volExist', title: 'Reservação Existente (m³)', format: 'number' },
        { key: 'necTotal', title: 'Necessária Total (m³)', format: 'number' },
        { key: 'acoes', title: 'Ações', format: 'actions' }
    ];

    // 2. Criar o Cabeçalho (Empreendimentos)
    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    
    // Célula vazia para o canto superior esquerdo
    headerRow.insertCell().textContent = 'Métrica'; 

    // Colunas dos empreendimentos
    historyData.forEach(item => {
        const th = headerRow.insertCell();
        th.innerHTML = `<b>${item.nomeProjeto || 'Empreendimento S/Nome'}</b>`;
        th.title = `ID: ${item.timestamp}`; 
    });
    
    // 3. Criar o Corpo da Tabela (Dados)
    const tbody = table.createTBody();

    metrics.forEach(metric => {
        if (metric.key.startsWith('spacer')) {
             const row = tbody.insertRow();
             row.style.height = '1px';
             row.innerHTML = `<td colspan="${historyData.length + 1}" style="padding:0;background:#eee;"></td>`;
             return;
        }

        const row = tbody.insertRow();
        row.insertCell().textContent = metric.title; // Título da métrica (primeira coluna)

        historyData.forEach((item, index) => {
            const cell = row.insertCell();
            const value = item[metric.key];
            const obrigatorio = item.obrigatorio;
            const atende = item.atendeTotal;
            const crit = item.critDen === 3 ? '1/3' : '1/5';

            switch (metric.format) {
                case 'number':
                    cell.textContent = fmtNum(value);
                    break;
                case 'percent':
                    cell.textContent = fmtNum(value) + '%';
                    break;
                case 'date':
                    try {
                        let dateStr = value;
                        if (dateStr) {
                             dateStr = new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR');
                        }
                        cell.textContent = dateStr || '—';
                    } catch (e) {
                        cell.textContent = value || '—';
                    }
                    break;
                case 'crit':
                    cell.textContent = crit;
                    break;
                case 'status':
                    const statusText = obrigatorio ? 'OBRIGATÓRIO' : (atende ? 'ADEQUADO' : 'INSUFICIENTE');
                    const statusClass = obrigatorio ? 'warn' : (atende ? 'ok' : 'bad');
                    cell.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
                    break;
                case 'deficit':
                    if (obrigatorio) {
                        cell.textContent = '—';
                    } else if (atende) {
                        cell.textContent = '—';
                    } else {
                        cell.textContent = fmtNum(value);
                        cell.classList.add('bad');
                    }
                    break;
                case 'actions':
                    cell.innerHTML = `
                        <div class="action-cell">
                            <button class="load-btn" data-index="${index}" title="Carregar dados para os campos de cálculo">Recarregar</button>
                            <button class="load-btn secondary" data-index="${index}" data-action="delete" title="Excluir este item">Excluir</button>
                        </div>
                    `;
                    break;
                case 'text':
                default:
                    cell.textContent = value || '—';
            }
        });
    });

    // 4. Adicionar Event Listeners (para as Ações)
    tbody.querySelectorAll('.load-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index, 10);
            if (e.target.dataset.action === 'delete') {
                excluirItemHistorico(index);
            } else {
                carregarEmpreendimento(index);
            }
        });
    });
  }

  function excluirItemHistorico(index) {
    if (confirm(`Tem certeza que deseja excluir o projeto "${historyData[index].nomeProjeto || 'S/Nome'}" do histórico?`)) {
        historyData.splice(index, 1);
        salvarHistorico();
        renderizarTabelaHistorico();
    }
  }

  function carregarEmpreendimento(index) {
    const dataToLoad = historyData[index];
    if (!dataToLoad) return;
    
    $('nomeProjeto').value = dataToLoad.nomeProjeto || '';
    $('software').value = dataToLoad.software || '';
    $('modeloBase').value = dataToLoad.modeloBase || '';
    $('dataCalibracao').value = dataToLoad.dataCalibracao && dataToLoad.dataCalibracao.includes('T00:00:00') 
        ? dataToLoad.dataCalibracao.split('T')[0] 
        : dataToLoad.dataCalibracao || '';
    
    $('volExist').value = dataToLoad.volExist || '';
    $('qExist').value = dataToLoad.qExist || '';
    $('uExist').value = dataToLoad.uExist || 'lps';

    $('economias').value = dataToLoad.economias || '';
    $('habEcon').value = dataToLoad.habEcon || '3';
    $('pcd').value = dataToLoad.pcd || '150';
    $('kdmc').value = dataToLoad.kdmc || '1.2';
    $('perdasPct').value = dataToLoad.perdasPct || '30';

    $('criterio').value = dataToLoad.critDen || '5';
    $('empUnit').value = dataToLoad.empUnit || 'm3d';

    Object.assign(last, dataToLoad); 

    mudarAba('tabCalculo');
    calcular(); 
    
    alert(`Dados do projeto "${dataToLoad.nomeProjeto || 'S/Nome'}" carregados com sucesso.`);
  }

  // Exportar/Importar Histórico (Backup)
  window.exportarHistorico = function() {
    if (historyData.length === 0) {
        alert('Não há dados no histórico para exportar.');
        return;
    }
    const dataStr = JSON.stringify(historyData, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `historico_reservacao_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  window.importarHistorico = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (!Array.isArray(importedData)) {
                throw new Error('O arquivo não contém um array de dados válido.');
            }
            
            if (confirm(`O arquivo contém ${importedData.length} itens. Deseja adicionar estes dados ao histórico existente (Total: ${historyData.length})?`)) {
                historyData = historyData.concat(importedData);
                salvarHistorico();
                renderizarTabelaHistorico();
                alert('Importação realizada com sucesso!');
            }
        } catch (error) {
            alert('Erro ao importar o arquivo: ' + error.message);
        }
    };
    reader.readAsText(file);
    event.target.value = null; 
  }

  // ==========================================================
  // NOVAS FUNÇÕES DE EXPORTAÇÃO DA TABELA (AJUSTADAS PARA PIVOT)
  // ==========================================================
  const metricsExport = [
        { key: 'nomeProjeto', title: 'Nome do Projeto', format: 'text' },
        { key: 'software', title: 'Software Utilizado', format: 'text' },
        { key: 'modeloBase', title: 'Modelo Base Utilizado', format: 'text' },
        { key: 'dataCalibracao', title: 'Data da Calibração', format: 'date' },
        { key: 'economias', title: 'Nº de Economias', format: 'number' },
        { key: 'habEcon', title: 'Habitantes por Economia', format: 'number' },
        { key: 'pcd', title: 'Consumo Per capita (L/hab·dia)', format: 'number' },
        { key: 'kdmc', title: 'KDMC', format: 'number' },
        { key: 'perdasPct', title: 'Perdas (%) da Demanda', format: 'percent' },
        { key: 'vazaoMediaM3d', title: 'Vazão Média (m³/dia)', format: 'number' },
        { key: 'consumoMaxDiarioM3d', title: 'Consumo Dia de Maior Consumo (m³/dia)', format: 'number' },
        { key: 'demandaPerdaM3d', title: 'Demanda de Perda (m³/dia)', format: 'number' },
        { key: 'demEmpM3d', title: 'Demanda Total do Empreendimento (m³/dia)', format: 'number' },
        { key: 'critDen', title: 'Critério de Reservação', format: 'crit' },
        { key: 'necEmp', title: 'Reservação Necessária (m³)', format: 'number' },
        { key: 'recomendaEmp', title: 'Volume Recomendado (Valor Real) (m³)', format: 'number' },
        { key: 'atendeTotal', title: 'Situação', format: 'status' },
        { key: 'deficitTotal', title: 'Déficit Total (m³)', format: 'number' },
        { key: 'volExist', title: 'Reservação Existente (m³)', format: 'number' },
        { key: 'necTotal', title: 'Necessária Total (m³)', format: 'number' },
    ];

  function getTableDataForExport(formatType) {
    // Cabeçalhos são os nomes dos projetos
    const headers = ['Métrica'].concat(historyData.map(item => item.nomeProjeto || 'Empreendimento S/Nome'));
    
    // As linhas são as métricas
    const dataRows = metricsExport.map(metric => {
        const row = [metric.title]; // Primeira coluna é o nome da métrica

        historyData.forEach(item => {
            let value = item[metric.key];
            
            const obrigatorio = item.obrigatorio;
            const atende = item.atendeTotal;
            const crit = item.critDen === 3 ? '1/3' : '1/5';

            switch (metric.format) {
                case 'number':
                    value = formatType === 'csv' ? fmtCSV(value) : fmtNum(value);
                    break;
                case 'percent':
                    value = formatType === 'csv' ? fmtCSV(value) + '%' : fmtNum(value) + '%';
                    break;
                case 'date':
                    try {
                        let dateStr = value;
                        if (dateStr) {
                             dateStr = new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR');
                        }
                        value = dateStr || '';
                    } catch (e) {
                        value = value || '';
                    }
                    break;
                case 'crit':
                    value = crit;
                    break;
                case 'status':
                    value = obrigatorio ? 'OBRIGATÓRIO' : (atende ? 'ADEQUADO' : 'INSUFICIENTE');
                    break;
                case 'text':
                default:
                    value = value || '';
            }
            // Deficit só aparece se não for obrigatório e não atender
            if (metric.key === 'deficitTotal' && (obrigatorio || atende)) {
                value = '';
            }
            
            row.push(value);
        });
        return row;
    });
    
    return { headers, dataRows };
  }

  // Exportar Tabela como CSV
  window.exportarTabelaCSV = function() {
    if (historyData.length === 0) {
        alert('Não há dados na tabela para exportar.');
        return;
    }
    
    const { headers, dataRows } = getTableDataForExport('csv');
    
    let csv = headers.map(h => `"${h}"`).join(';') + '\n';
    
    dataRows.forEach(row => {
        const csvRow = row.map(cell => {
            return String(cell).includes(';') ? `"${String(cell).replace(/"/g, '""')}"` : cell;
        }).join(';');
        csv += csvRow + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    link.href = URL.createObjectURL(blob);
    link.download = `Tabela_Historico_Reservacao_Pivotada_${new Date().toISOString().slice(0, 10)}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  }

  // Copiar Tabela para a Área de Transferência
  window.copiarTabelaParaClipboard = function() {
    if (historyData.length === 0) {
        alert('Não há dados na tabela para copiar.');
        return;
    }

    const { headers, dataRows } = getTableDataForExport('tab');
    
    let tabSeparated = headers.join('\t') + '\n';
    
    dataRows.forEach(row => {
        const tabRow = row.map(cell => String(cell)).join('\t');
        tabSeparated += tabRow + '\n';
    });
    
    const tempElement = document.createElement('textarea');
    tempElement.value = tabSeparated;
    document.body.appendChild(tempElement);
    tempElement.select();
    
    try {
        document.execCommand('copy');
        alert('Tabela de dados copiada com sucesso! Cole diretamente na sua planilha (Ctrl+V).');
    } catch (err) {
        alert('Erro ao copiar. Por favor, tente exportar para CSV ou selecione e copie a tabela manualmente.');
    }
    
    document.body.removeChild(tempElement);
  }


  // ==========================================================
  // FUNÇÕES GERAIS E EVENTOS
  // ==========================================================

  function mudarAba(tabId) {
    document.querySelectorAll('.tab-content > div').forEach(div => div.classList.remove('active'));
    document.querySelectorAll('.tab-nav button').forEach(btn => btn.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');
    document.getElementById('tab' + tabId.replace('tab', '') + 'Btn').classList.add('active');
  }

  function gerarRelatorio(){
    const dt = new Date();
    const marca = dt.toLocaleString('pt-BR');
    const uExistRot = last.uExist === 'lps' ? 'L/s' : 'm³/h';
    const cTxt = critText();
    
    const fDataCalib = last.dataCalibracao ? new Date(last.dataCalibracao + 'T00:00:00').toLocaleDateString('pt-BR') : '—';
    const blocoDadosProjeto = `
      <h2>Dados do Projeto e Modelo</h2>
      <div class="box kv">
        <div>Nome do Projeto</div><div><b>${last.nomeProjeto || '—'}</b></div>
        <div>Software Utilizado</div><div><b>${last.software || '—'}</b></div>
        <div>Modelo Base Utilizado</div><div><b>${last.modeloBase || '—'}</b></div>
        <div>Data da Calibração</div><div><b>${fDataCalib}</b></div>
      </div>
    `;

    const blocoVerif = last.obrigatorio ? `
      <h2>Regra de obrigatoriedade</h2>
      <div class="box kv">
        <div>Nº de economias</div><div><b>${(last.economias||0).toLocaleString('pt-BR')}</b></div>
        <div>Situação</div><div><b>Obrigatório novo reservatório para o empreendimento (economias ≥ 120)</b></div>
      </div>
    ` : `
      <h2>Verificação (total)</h2>
      <div class="box kv">
        <div>Reservatório existente</div><div><b>${fmt(last.volExist,'m³')}</b></div>
        <div>Situação total</div><div><b class="${ last.atendeTotal ? 'ok' : 'bad' }">${ last.atendeTotal ? `Adequado (≥ ${cTxt})` : `Insuficiente (< ${cTxt})` }</b></div>
        ${ last.atendeTotal
            ? `<div>Superávit (vs. total)</div><div><b>${fmt(last.superavitTotal,'m³')}</b></div>`
            : `<div>Déficit (vs. total)</div><div><b>${fmt(last.deficitTotal,'m³')}</b></div>` }
      </div>
    `;

    const concl = (function(){
      const c = document.createElement('div');
      c.innerHTML = document.getElementById('conclusaoText').innerHTML || '';
      const leadTxt = document.getElementById('conclusaoLead').innerText || '';
      return { html: c.innerHTML, lead: leadTxt };
    })();

    const blocoConclusao = (concl.html && concl.html.trim()) ? `
      <h2>Conclusão / Resultado final</h2>
      <div class="box">
        ${concl.lead ? `<p><b>${concl.lead}</b></p>` : ''}
        ${concl.html}
      </div>
    ` : '';
    
    const html = `
<!DOCTYPE html><html lang="pt-BR"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Relatório – Memorial de Cálculo</title>
<style>
  body{font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:24px;color:#111}
  header{display:flex;justify-content:center;align-items:center;padding:8px 0;border-bottom:1px solid #ddd;margin-bottom:8px}
  .brand{font-weight:900;letter-spacing:.25rem;text-transform:uppercase;font-size:20px}
  h1{margin:8px 0} h2{margin:18px 0 6px} h3{margin:14px 0 4px}
  .kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px}
  .muted{color:#555} .box{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
  hr{border:none;border-top:1px solid #e5e7eb;margin:12px 0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .bad{color:#b91c1c;font-weight:700} .ok{color:#166534;font-weight:700} .note{color:#555}
  footer{margin-top:18px;color:#444}
  @media print {.no-print{display:none}}
</style>
</head><body>
  <header><div class="brand">AEGEA</div></header>

  <h1>Memorial de Cálculo – Reservação (${cTxt})</h1>
  <div class="muted">Emitido em ${marca}</div>

  ${blocoDadosProjeto}

  <h2>Entradas (Sistema e Empreendimento)</h2>
  <div class="box kv">
    <div>Reservação existente</div><div><b>${fmt(last.volExist,'m³')}</b></div>
    <div>Demanda + Perdas existente</div><div><b>${fmt(last.qExist,uExistRot)}</b></div>
    <div>Demanda existente (m³/dia)</div><div><b>${fmt(last.demExistM3d,'m³/dia')}</b></div>
    <div>Nº de economias (empreendimento)</div><div><b>${(last.economias||0).toLocaleString('pt-BR')}</b></div>
    <div>Hab/economia</div><div><b>${last.habEcon.toLocaleString('pt-BR')}</b></div>
    <div>Per capita</div><div><b>${fmt(last.pcd,'L/hab·dia')}</b></div>
    <div>KDMC</div><div><b>${last.kdmc.toLocaleString('pt-BR')}</b></div>
    <div>Perdas (%)</div><div><b>${last.perdasPct.toLocaleString('pt-BR')}</b></div>
  </div>

  <h2>Demanda do empreendimento</h2>
  <p class="mono">Demanda Total (L/dia) = Consumo Máximo Diário (com KDMC) + Demanda de Perda</p>
  <p class="mono">Consumo Dia de Maior Consumo (m³/dia) = Economias × Hab/Econ × Per capita × KDMC / 1000</p>
  <div class="box kv">
    <div>Vazão Média (sem KDMC e Perdas)</div><div><b>${fmt(last.vazaoMediaM3d,'m³/dia')}</b></div>
    <div>Consumo Dia de Maior Consumo (c/ KDMC e s/ Perdas)</div><div><b>${fmt(last.consumoMaxDiarioM3d,'m³/dia')}</b></div>
    <div>Demanda de Perda</div><div><b>${fmt(last.demandaPerdaM3d,'m³/dia')}</b></div>
    <div>Demanda Total (Empreendimento c/ Perdas)</div><div><b>${fmt(last.demEmpM3d,'m³/dia')}</b></div>
  </div>

  <h2>Reservações necessárias (critério ${cTxt})</h2>
  <div class="box kv">
    <div>Necessária – EXISTENTE (${cTxt})</div><div><b>${fmt(last.necExist,'m³')}</b></div>
    <div>Necessária – EMPREENDIMENTO (${cTxt})</div><div><b>${fmt(last.necEmp,'m³')}</b></div>
    <div>Necessária – TOTAL (${cTxt})</div><div><b>${fmt(last.necTotal,'m³')}</b></div>
  </div>

  ${blocoVerif}
  ${blocoConclusao}

  <h2>Dimensionamento do Reservatório do Empreendimento</h2>
  <div class="box kv">
    <div>Volume Recomendado (Valor Real ${cTxt})</div><div><b>${fmt(last.recomendaEmp,'m³')}</b></div>
  </div>
  ${ last.existAtendeAtual ? '' : '<div class="box"><b>Atenção:</b> o reservatório existente não atende a demanda atual (sem o empreendimento). Dimensionar somente o reservatório do empreendimento não regulariza o sistema existente.</div>'}

  <hr/>
  <button class="no-print" onclick="window.print()">Imprimir/Salvar PDF</button>

  <footer>Desenvolvido por <b>kelvin zeferino de souza</b></footer>
</body></html>`;

    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
    w.focus();
  }


  /* ===================== EVENTOS ===================== */
  
  // Eventos de entrada (dispara o cálculo)
  ['nomeProjeto','software','modeloBase','dataCalibracao','volExist','qExist','economias','habEcon','pcd','kdmc', 'perdasPct', 'uExist','empUnit','criterio']
    .forEach(id => {
        const el = $(id);
        const event = ['uExist','empUnit','criterio'].includes(id) ? 'change' : 'input';
        el.addEventListener(event, calcular);
    });

  // Botões de Navegação
  $('tabCalcBtn').addEventListener('click', () => mudarAba('tabCalculo'));
  $('tabHistoryBtn').addEventListener('click', () => {
    mudarAba('tabHistorico');
    renderizarTabelaHistorico();
  });

  // Botões de Exportação/Cópia da Tabela
  $('btnExportCSV').addEventListener('click', exportarTabelaCSV);
  $('btnCopyTable').addEventListener('click', copiarTabelaParaClipboard);

  // Botão Salvar Empreendimento
  $('btnSalvarEmp').addEventListener('click', () => {
    if (!last.nomeProjeto.trim()) {
        alert('Por favor, preencha o "Nome do Projeto" antes de salvar.');
        return;
    }
    
    const project = { ...last, timestamp: new Date().getTime() };
    const existingIndex = historyData.findIndex(item => item.nomeProjeto === project.nomeProjeto);
    
    if (existingIndex !== -1) {
        if (confirm(`Já existe um projeto chamado "${project.nomeProjeto}". Deseja atualizar os dados salvos com os resultados atuais?`)) {
            historyData[existingIndex] = project;
            alert(`Projeto "${project.nomeProjeto}" atualizado com sucesso!`);
        } else {
            return; 
        }
    } else {
        historyData.unshift(project);
        alert(`Projeto "${project.nomeProjeto}" salvo com sucesso!`);
    }

    salvarHistorico();
    renderizarTabelaHistorico();
    mudarAba('tabHistorico');
  });

  $('btnClear').addEventListener('click', () => {
    if (!confirm('Deseja limpar todos os campos de entrada?')) return;
    $('nomeProjeto').value = ''; $('software').value = ''; $('modeloBase').value = ''; $('dataCalibracao').value = '';
    $('volExist').value = ''; $('qExist').value = ''; $('uExist').value = 'lps';
    $('economias').value = ''; $('habEcon').value = 3; $('pcd').value = 150; 
    $('kdmc').value = 1.2; $('perdasPct').value = 30;
    $('criterio').value = '5'; $('empUnit').value = 'm3d';
    
    // Reseta o estado
    last = {
      nomeProjeto:'', software:'', modeloBase:'', dataCalibracao:'', volExist:0, qExist:0, uExist:'lps',
      economias:0, habEcon:3, pcd:150, kdmc:1.2, perdasPct:30, critDen:5, empUnit:'m3d',
      demandaBaseLd: 0, vazaoMediaM3d: 0, consumoMaxDiarioM3d: 0, demandaPerdaM3d: 0, 
      demExistM3d:0, demEmpLd:0, demEmpM3d:0, demEmpM3h:0, demEmpLs:0, necExist:0, necEmp:0, necTotal:0,
      atendeTotal:false, deficitTotal:0, superavitTotal:0, recomendaEmp:0, alvoEmp:0,
      existAtendeAtual:true, obrigatorio:false, timestamp: null
    };

    calcular();
  });

  $('btnRelatorio').addEventListener('click', gerarRelatorio);

  // Inicialização
  atualizarCritRotulos();
  calcular();
})();
</script>
</body>
</html>