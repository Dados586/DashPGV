<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Propostas Oeste - Gest√£o de Obras PGV</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- SheetJS para ler Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
        }

        /* SIDEBAR */
        #sidebar {
            position: fixed;
            left: 0; 
            top: 0;
            width: 260px;
            height: 100vh;
            background: #1a2332;
            color: white;
            padding: 0;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 25px 20px;
            background: #0f1419;
            border-bottom: 1px solid #2d3748;
            text-align: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 22px;
            color: #4fc3f7;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .sidebar-header p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #a0aec0;
        }

        .sidebar-section {
            padding: 20px;
        }

        .sidebar-section h4 {
            margin: 0 0 15px 0;
            font-size: 11px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .filter-item {
            background: #2d3748;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-item:hover {
            background: #3d495d;
            border-left-color: #4fc3f7;
            transform: translateX(5px);
        }

        .filter-item.active {
            background: #4fc3f7;
            color: #1a2332;
            font-weight: 600;
            border-left-color: #fff;
        }

        .project-count {
            background: #0f1419;
            padding: 20px;
            margin-top: auto;
            text-align: center;
            border-top: 1px solid #2d3748;
        }

        .project-count .number {
            font-size: 36px;
            font-weight: 800;
            color: #4fc3f7;
        }

        .project-count .label {
            font-size: 12px;
            color: #a0aec0;
            text-transform: uppercase;
        }

        #status {
            margin: 10px 20px;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        #status.success { background: #10b981; color: white; }
        #status.error { background: #ef4444; color: white; }
        #status.loading { background: #f59e0b; color: white; }

        /* CONTE√öDO PRINCIPAL */
        #mainContent {
            margin-left: 260px;
            min-height: 100vh;
        }

        /* MAPA */
        #mapSection {
            position: relative;
            height: 450px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-header {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 500;
            backdrop-filter: blur(4px);
        }

        .map-header h3 {
            margin: 0;
            font-size: 16px;
            color: #1a2332;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* DASHBOARD */
        #dashboard {
            padding: 30px;
        }

        .dashboard-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .dashboard-header h2 {
            margin: 0 0 5px 0;
            font-size: 28px;
            color: #1a2332;
            font-weight: 700;
        }

        .dashboard-header p {
            margin: 0;
            color: #64748b;
            font-size: 15px;
        }

        /* CARDS KPI */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
            border-top: 4px solid #4fc3f7;
            position: relative;
            transition: transform 0.2s;
        }

        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card.green { border-top-color: #10b981; }
        .kpi-card.blue { border-top-color: #3b82f6; }
        .kpi-card.purple { border-top-color: #8b5cf6; }
        .kpi-card.orange { border-top-color: #f59e0b; }
        .kpi-card.red { border-top-color: #ef4444; }
        .kpi-card.cyan { border-top-color: #06b6d4; }

        .kpi-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .kpi-subtext {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 5px;
        }

        /* GR√ÅFICOS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        }

        .chart-card h3 {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 320px;
        }

        /* TABELA */
        .table-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04);
            overflow-x: auto;
        }

        .table-card h3 {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th {
            background: #f8fafc;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            font-size: 13px;
        }

        tr:hover { background: #f8fafc; }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-blue { background: #e0f2fe; color: #0369a1; }
        .badge-green { background: #dcfce7; color: #15803d; }

        /* POPUP */
        .popup-content {
            font-size: 13px;
            min-width: 280px;
            padding: 5px;
        }

        .popup-header {
            font-weight: 700;
            font-size: 15px;
            color: #1a2332;
            margin-bottom: 10px;
            border-bottom: 2px solid #4fc3f7;
            padding-bottom: 5px;
        }

        .popup-section {
            margin-bottom: 12px;
        }

        .popup-section strong {
            display: block;
            margin-bottom: 6px;
            color: #475569;
            font-size: 11px;
            text-transform: uppercase;
        }

        .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed #f1f5f9;
        }

        .popup-label { color: #64748b; }
        .popup-value { font-weight: 600; color: #1e293b; }

        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            #sidebar { width: 0; display: none; }
            #mainContent { margin-left: 0; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <h2>Propostas Oeste</h2>
        <p>Gest√£o de Obras PGV</p>
    </div>
    
    <div id="status" style="display:none;"></div>
    
    <div class="sidebar-section">
        <h4>Filtros por Zona</h4>
        <div id="listaZonas">Carregando...</div>
    </div>
    
    <div class="project-count">
        <div class="number" id="projectCount">0</div>
        <div class="label">PGVs Selecionados</div>
    </div>
</div>

<!-- CONTE√öDO PRINCIPAL -->
<div id="mainContent">
    <!-- MAPA -->
    <div id="mapSection">
        <div class="map-header">
            <h3>üìç Localiza√ß√£o das Obras</h3>
        </div>
        <div id="map"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="dashboard-header">
            <div>
                <h2 id="dashTitle">Dashboard Consolidado</h2>
                <p>An√°lise t√©cnica e financeira das V√°lvulas Redutoras de Press√£o</p>
            </div>
            <div id="lastUpdate" style="font-size: 12px; color: #94a3b8;"></div>
        </div>

        <div id="dashboardContent">
            <!-- KPIs Iniciais -->
            <div class="kpi-grid" id="kpiContainer">
                <!-- Preenchido via JS -->
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Viabilidade Financeira (VPL vs CAPEX)</h3>
                    <div class="chart-container">
                        <canvas id="chartFinanceiro"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Efici√™ncia: Perda Evitada (m¬≥/m√™s)</h3>
                    <div class="chart-container">
                        <canvas id="chartEficiencia"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Redu√ß√£o de Press√£o (mca)</h3>
                    <div class="chart-container">
                        <canvas id="chartPressao"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Payback por Obra (Anos)</h3>
                    <div class="chart-container">
                        <canvas id="chartPayback"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="table-card">
                <h3>Detalhamento T√©cnico e Financeiro</h3>
                <div id="tableContainer">
                    <p class="empty-state">Carregando dados...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', function() {

// ============================
// CONFIGURA√á√ïES
// ============================
const URL_GEOJSON = "https://raw.githubusercontent.com/Dados586/Dados_Modelagem/refs/heads/main/pgvs-oeste.geojson";
const URL_EXCEL = "https://raw.githubusercontent.com/Dados586/Dados_Modelagem/main/Base-pgvs.xlsx";

// ============================
// INICIALIZAR MAPA
// ============================
var map = L.map('map').setView([-30, -55.8], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
}).addTo(map);

var layerImportado = L.layerGroup().addTo(map);
var geojsonLayer; 

let todasFeatures = [];
let zonasUnicas = [];
let zonaAtiva = "TODAS";
let dadosExcel = [];
let excelCarregado = false;
let charts = {};

// ============================
// FUN√á√ïES AUXILIARES
// ============================
function mostrarStatus(mensagem, tipo) {
    const status = document.getElementById("status");
    status.textContent = mensagem;
    status.className = tipo;
    status.style.display = "block";
}

function buscarDadosExcel(feature) {
    if (!excelCarregado || dadosExcel.length === 0) return null;
    const zonaFeature = feature.properties.ZONA;
    const obraFeature = feature.properties.OBRA;
    
    return dadosExcel.find(row => 
        (row.Zona === zonaFeature) || 
        (row.Obra === obraFeature) ||
        (row.ID === feature.properties.ID)
    );
}

function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
}

function formatarNumero(valor, casas = 0) {
    return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: casas, maximumFractionDigits: casas }).format(valor || 0);
}

// ============================
// ATUALIZAR DASHBOARD
// ============================
function atualizarDashboard(zona) {
    zonaAtiva = zona;
    document.getElementById('dashTitle').textContent = zona === "TODAS" ? "Dashboard Consolidado" : `Dashboard: ${zona}`;
    
    const filtradas = todasFeatures.filter(f => {
        if (zona === "TODAS") return true;
        return f.properties.ZONA === zona;
    });

    document.getElementById('projectCount').textContent = filtradas.length;

    let stats = {
        capex: 0, vpl: 0, perdaEvitada: 0, economiaAno: 0, 
        vazamentoEvitado: 0, pressaoMedia: 0, paybackMedio: 0, tirMedia: 0, count: 0
    };

    const dadosParaGraficos = [];

    filtradas.forEach(f => {
        const d = buscarDadosExcel(f);
        if (d) {
            stats.capex += parseFloat(d['CAPEX (R$)'] || 0);
            stats.vpl += parseFloat(d['VPL'] || 0);
            stats.perdaEvitada += parseFloat(d['Perda Evitada (m¬≥/m√™s)'] || 0);
            stats.economiaAno += parseFloat(d['R$ Evitados/ano'] || 0);
            stats.vazamentoEvitado += parseFloat(d['R$ Evitado Vaz/ano'] || 0);
            stats.pressaoMedia += parseFloat(d['Redu√ß√£o Press√£o (mca)'] || 0);
            stats.paybackMedio += parseFloat(d['Payback (anos)'] || 0);
            stats.tirMedia += parseFloat(d['TIR'] || 0);
            stats.count++;
            
            dadosParaGraficos.push({
                label: d.Obra || d.Zona,
                capex: parseFloat(d['CAPEX (R$)'] || 0),
                vpl: parseFloat(d['VPL'] || 0),
                perda: parseFloat(d['Perda Evitada (m¬≥/m√™s)'] || 0),
                pressao: parseFloat(d['Redu√ß√£o Press√£o (mca)'] || 0),
                payback: parseFloat(d['Payback (anos)'] || 0)
            });
        }
    });

    if (stats.count > 0) {
        stats.pressaoMedia /= stats.count;
        stats.paybackMedio /= stats.count;
        stats.tirMedia = (stats.tirMedia / stats.count) * 100;
    }

    const kpiContainer = document.getElementById('kpiContainer');
    kpiContainer.innerHTML = `
        <div class="kpi-card blue">
            <div class="kpi-label">Investimento (CAPEX)</div>
            <div class="kpi-value">${formatarMoeda(stats.capex)}</div>
            <div class="kpi-subtext">Total em ${stats.count} PGVs</div>
        </div>
        <div class="kpi-card green">
            <div class="kpi-label">Retorno (VPL)</div>
            <div class="kpi-value">${formatarMoeda(stats.vpl)}</div>
            <div class="kpi-subtext">Valor Presente L√≠quido</div>
        </div>
        <div class="kpi-card orange">
            <div class="kpi-label">Economia Total / Ano</div>
            <div class="kpi-value">${formatarMoeda(stats.economiaAno)}</div>
            <div class="kpi-subtext">R$ evitados totais</div>
        </div>
        <div class="kpi-card cyan">
            <div class="kpi-label">Vazamentos Evitados</div>
            <div class="kpi-value">${formatarMoeda(stats.vazamentoEvitado)}</div>
            <div class="kpi-subtext">R$ evitados vazamentos/ano</div>
        </div>
        <div class="kpi-card purple">
            <div class="kpi-label">Perda Evitada</div>
            <div class="kpi-value">${formatarNumero(stats.perdaEvitada)} m¬≥/m√™s</div>
            <div class="kpi-subtext">Volume recuperado</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Payback M√©dio</div>
            <div class="kpi-value">${stats.paybackMedio.toFixed(1)} anos</div>
            <div class="kpi-subtext">Tempo de retorno</div>
        </div>
        <div class="kpi-card ${stats.tirMedia > 15 ? 'green' : ''}">
            <div class="kpi-label">TIR M√©dia</div>
            <div class="kpi-value">${stats.tirMedia.toFixed(1)}%</div>
            <div class="kpi-subtext">Taxa Interna de Retorno</div>
        </div>
    `;

    renderizarTabela(filtradas);
    renderizarGraficos(dadosParaGraficos);

    if (geojsonLayer) {
        const featuresFiltradas = [];
        geojsonLayer.eachLayer(layer => {
            if (zona === "TODAS" || layer.feature.properties.ZONA === zona) {
                featuresFiltradas.push(layer);
            }
        });

        if (featuresFiltradas.length > 0) {
            const group = L.featureGroup(featuresFiltradas);
            // AJUSTE DO ZOOM: Reduzindo o padding para aproximar mais
            // Se for apenas uma obra, o zoom ser√° mais intenso (maxZoom: 17)
            // Se for uma zona com v√°rias obras, o padding garante que todas apare√ßam
            const isSingleProject = featuresFiltradas.length === 1;
            map.flyToBounds(group.getBounds(), { 
                padding: isSingleProject ? [150, 150] : [60, 60], 
                duration: 1.5, 
                maxZoom: isSingleProject ? 17 : 15 
            });
        }
    }
}

function renderizarTabela(features) {
    const container = document.getElementById('tableContainer');
    if (features.length === 0) {
        container.innerHTML = '<p class="empty-state">Nenhum dado dispon√≠vel para esta sele√ß√£o.</p>';
        return;
    }

    let html = `<table>
        <thead>
            <tr>
                <th>Obra / Zona</th>
                <th>CAPEX</th>
                <th>Red. Press√£o</th>
                <th>% Red. Perdas</th>
                <th>Perda Evitada</th>
                <th>R$ Evitados/Ano</th>
                <th>VPL</th>
                <th>TIR</th>
                <th>Payback</th>
            </tr>
        </thead>
        <tbody>`;

    features.forEach(f => {
        const d = buscarDadosExcel(f);
        if (d) {
            html += `
                <tr>
                    <td><strong>${d.Obra || d.Zona}</strong></td>
                    <td>${formatarMoeda(d['CAPEX (R$)'])}</td>
                    <td>${d['Redu√ß√£o Press√£o (mca)']} mca</td>
                    <td>${((d['% Redu√ß√£o Perdas'] || 0) * 100).toFixed(1)}%</td>
                    <td>${formatarNumero(d['Perda Evitada (m¬≥/m√™s)'])} m¬≥/m√™s</td>
                    <td>${formatarMoeda(d['R$ Evitados/ano'])}</td>
                    <td><span class="badge badge-blue">${formatarMoeda(d['VPL'])}</span></td>
                    <td>${((d['TIR'] || 0) * 100).toFixed(1)}%</td>
                    <td><span class="badge badge-green">${d['Payback (anos)']} anos</span></td>
                </tr>
            `;
        }
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

function renderizarGraficos(dados) {
    const labels = dados.map(d => d.label);
    Object.values(charts).forEach(chart => chart.destroy());

    charts.financeiro = new Chart(document.getElementById('chartFinanceiro'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'CAPEX', data: dados.map(d => d.capex), backgroundColor: '#3b82f6' },
                { label: 'VPL', data: dados.map(d => d.vpl), backgroundColor: '#10b981' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    charts.eficiencia = new Chart(document.getElementById('chartEficiencia'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'm¬≥/m√™s',
                data: dados.map(d => d.perda),
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    charts.pressao = new Chart(document.getElementById('chartPressao'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'mca',
                data: dados.map(d => d.pressao),
                backgroundColor: '#f59e0b'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    charts.payback = new Chart(document.getElementById('chartPayback'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Anos',
                data: dados.map(d => d.payback),
                backgroundColor: '#ef4444'
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            indexAxis: 'y'
        }
    });
}

// ============================
// CARREGAR DADOS COM CACHE-BUSTING
// ============================
async function carregarExcel(url) {
    try {
        mostrarStatus("Lendo planilha financeira...", "loading");
        const cacheBuster = `?t=${new Date().getTime()}`;
        const response = await fetch(url + cacheBuster);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames.find(n => n.includes('RESUMO')) || workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        dadosExcel = XLSX.utils.sheet_to_json(sheet);
        excelCarregado = true;
        return true;
    } catch (err) {
        console.error(err);
        return false;
    }
}

async function carregarGeoJSON(url) {
    try {
        mostrarStatus("Carregando mapa...", "loading");
        const cacheBuster = `?t=${new Date().getTime()}`;
        const response = await fetch(url + cacheBuster);
        const geojson = await response.json();
        
        todasFeatures = geojson.features || [];
        zonasUnicas = [...new Set(todasFeatures.map(f => f.properties.ZONA))].filter(Boolean).sort();

        montarListaZonas();
        
        geojsonLayer = L.geoJSON(geojson, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                radius: 9, color: "#fff", fillColor: "#3b82f6", fillOpacity: 0.9, weight: 2
            }),
            onEachFeature: (feature, layer) => {
                const d = buscarDadosExcel(feature);
                let content = `<div class="popup-content"><div class="popup-header">${d ? (d.Obra || d.Zona) : 'Obra'}</div>`;
                
                if (d) {
                    content += `
                        <div class="popup-section">
                            <strong>Financeiro</strong>
                            <div class="popup-row"><span class="popup-label">CAPEX:</span><span class="popup-value">${formatarMoeda(d['CAPEX (R$)'])}</span></div>
                            <div class="popup-row"><span class="popup-label">VPL:</span><span class="popup-value">${formatarMoeda(d['VPL'])}</span></div>
                            <div class="popup-row"><span class="popup-label">Payback:</span><span class="popup-value">${d['Payback (anos)']} anos</span></div>
                        </div>
                        <div class="popup-section">
                            <strong>T√©cnico</strong>
                            <div class="popup-row"><span class="popup-label">Red. Press√£o:</span><span class="popup-value">${d['Redu√ß√£o Press√£o (mca)']} mca</span></div>
                            <div class="popup-row"><span class="popup-label">Perda Evitada:</span><span class="popup-value">${formatarNumero(d['Perda Evitada (m¬≥/m√™s)'])} m¬≥/m√™s</span></div>
                        </div>`;
                }
                content += `</div>`;
                layer.bindPopup(content);
                layer.on('click', () => {
                    if (feature.properties.ZONA) filtrarZona(feature.properties.ZONA);
                });
            }
        }).addTo(layerImportado);

        atualizarDashboard("TODAS");
        return true;
    } catch (err) {
        mostrarStatus("Erro ao carregar mapa", "error");
        return false;
    }
}

function montarListaZonas() {
    const div = document.getElementById("listaZonas");
    div.innerHTML = `<div class="filter-item active" onclick="filtrarZona('TODAS')"><span>TODAS</span> <span>${todasFeatures.length}</span></div>`;
    
    zonasUnicas.forEach(z => {
        const count = todasFeatures.filter(f => f.properties.ZONA === z).length;
        const item = document.createElement("div");
        item.className = "filter-item";
        item.innerHTML = `<span>${z}</span> <span style="opacity:0.6; font-size:11px">${count}</span>`;
        item.onclick = () => filtrarZona(z);
        div.appendChild(item);
    });
}

window.filtrarZona = function(zona) {
    document.querySelectorAll('.filter-item').forEach(el => {
        el.classList.remove('active');
        if (el.textContent.includes(zona)) el.classList.add('active');
    });
    atualizarDashboard(zona);
};

async function inicializar() {
    await carregarExcel(URL_EXCEL);
    await carregarGeoJSON(URL_GEOJSON);
    mostrarStatus("‚úì Dados sincronizados", "success");
    setTimeout(() => document.getElementById("status").style.display = "none", 3000);
}

inicializar();

});
</script>

</body>
</html>
