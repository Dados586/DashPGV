<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HydroResolve — Séries Temporais (Reservatórios • Vazão &amp; Pressão • Liga/Desliga • COI • Dados Galax)</title>
<style>
  :root{
    --primary:#0a6cff;--bg:#0c1117;--card:#141a22;--muted:#8aa0b4;
    --text:#e7eef5;--accent:#18c79c;--warn:#ffb020;--error:#ff5d5d;--border:#233041
  }
  *{box-sizing:border-box}
  body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0c1117;color:var(--text)}
  h1,h2{margin:0 0 12px;font-weight:700} h1{font-size:1.4rem;color:var(--accent)} h2{font-size:1.1rem}
  p{color:var(--muted)}
  .tabs{display:flex;gap:8px;margin:8px 0 0;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f151d;color:#9bc1ff;cursor:pointer;user-select:none}
  .tab.active{background:#132033}
  .grid{display:grid;gap:16px;grid-template-columns:1.1fr 1fr;max-width:1200px;margin:0 auto}
  .card{background:#141a22;border:1px solid var(--border);border-radius:12px;padding:16px}
  label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],select,textarea{width:100%;background:#0f151d;color:#fff;border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:.95rem}
  textarea{min-height:140px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  button{background:var(--primary);border:none;color:white;font-weight:600;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#1f2a39;color:#fff;border:1px solid var(--border)}
  button.danger{background:#a23b3b}
  button:disabled{opacity:.6;cursor:not-allowed}
  .messages{margin-top:10px}
  .msg{padding:8px 10px;border-radius:8px;margin-bottom:6px}
  .msg.warn{background:#2a2110;border:1px solid #3a2d12;color:#ffd279}
  .msg.error{background:#31181a;border:1px solid #3a1e21;color:#ffb3b3}
  .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .kpi{background:#101823;border:1px solid var(--border);border-radius:10px;padding:10px}
  .kpi .title{color:var(--muted);font-size:.8rem}
  .kpi .value{font-weight:700;font-size:1rem}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.92rem}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{position:sticky;top:0;background:#101824;color:#c7d7ea;text-align:left;z-index:1}
  tbody tr:hover{background:#101823}
  progress{width:100%;height:12px}
  footer{margin-top:16px;text-align:center;color:#8aa0b4;font-size:.9rem}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0f151d}
  .pill b{color:#cfe1ff}
  .pill button{background:#2b3545;border:1px solid #41526d;color:#fff;padding:2px 6px;border-radius:6px;cursor:pointer;font-size:.8rem}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .projbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .projbar .title{font-weight:700;color:#9bc1ff;margin-right:8px}
  .config-table{width:100%;border-collapse:collapse;margin-top:8px}
  .config-table th,.config-table td{padding:8px;border:1px solid var(--border)}
  .config-table th{background:#101824}
  .config-table input{width:100%;background:#0f151d;color:#fff;border:1px solid var(--border);border-radius:4px;padding:6px 8px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}.summary{grid-template-columns:1fr}}
</style>
</head>
<body>
<h1>HydroResolve — Séries Temporais</h1>
<p class="hint">
  Módulos: <b>Reservatórios</b> (converte %→Nível), <b>Vazão &amp; Pressão</b> (valor direto; 0 é válido), <b>Liga/Desliga (0/1)</b> (degrau), <b>Dados COI scada</b> (consolidação) e <b>Dados Galax</b> (pressão).
</p>

<section class="card">
  <div class="projbar">
    <span class="title">Projeto</span>
    <button id="projSave" class="secondary">Salvar projeto (.json)</button>
    <button id="projLoad" class="secondary">Carregar projeto (.json)</button>
    <button id="projClear" class="secondary">Limpar tudo</button>
    <span id="projStatus" class="hint"></span>
    <input id="projFile" type="file" accept=".json,application/json" style="display:none" />
  </div>
  <p class="hint" style="margin-top:8px">
    O projeto salva os <b>resultados atuais</b> (Reservatórios, Vazão &amp; Pressão, Liga/Desliga e Dados Galax).
  </p>
</section>

<div class="tabs" id="modTabs">
  <div class="tab active" data-mod="res">Reservatórios</div>
  <div class="tab" data-mod="vp">Vazão &amp; Pressão</div>
  <div class="tab" data-mod="ld">Liga/Desliga (0/1)</div>
  <div class="tab" data-mod="galax">Dados Galax</div>
  <div class="tab" data-mod="coi">Dados COI scada</div>
</div>

<div id="modRes" style="display:block;">
  <div class="tabs" id="resTabs">
    <div class="tab active" data-pane="resEntrada">Entrada</div>
    <div class="tab" data-pane="resResultados">Resultados</div>
    <div class="tab" data-pane="resTratamento">Tratamento</div>
  </div>

  <div id="resEntrada" class="grid" style="margin-top:10px">
    <section class="card">
      <h2>Entrada — Reservatório</h2>
      
      <div class="tabs" id="resModoTabs">
        <div class="tab active" data-mode="single">Dado Único</div>
        <div class="tab" data-mode="multi">Múltiplos Dados (CSV)</div>
      </div>

      <div id="resSinglePane" style="margin-top:8px">
        <div class="row">
          <div>
            <label for="resNome">Nome</label>
            <input id="resNome" type="text" placeholder="Ex.: R1" />
          </div>
          <div>
            <label for="resPrimeiraLinhaTitulo">Opções</label>
            <div style="display:flex;gap:10px;align-items:center">
              <input type="checkbox" id="resPrimeiraLinhaTitulo" />
              <label for="resPrimeiraLinhaTitulo" style="margin:0">Primeira linha é o título nos dados</label>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label for="resVol">Volume total (m³)</label>
            <input id="resVol" type="text" inputmode="decimal" placeholder="Ex.: 1250,5" />
          </div>
          <div>
            <label for="resDiam">Diâmetro interno (m)</label>
            <input id="resDiam" type="text" inputmode="decimal" placeholder="Ex.: 12,0" />
          </div>
        </div>

        <div class="tabs" id="resSingleModoTabs">
          <div class="tab active" data-submode="paste">Colar dados</div>
          <div class="tab" data-submode="file">Arquivo (.txt/.csv)</div>
        </div>

        <div id="resSinglePastePane" style="margin-top:8px">
          <label for="resDados">Dados: <code>dd/mm/aaaa HH:MM[:SS]</code> + TAB + <code>% volume</code></label>
          <textarea id="resDados" placeholder="Exemplo:
01/08/2025 00:01    74,05000305
01/08/2025 00:01    74,19999695
01/08/2025 00:02    74,375"></textarea>
        </div>

        <div id="resSingleFilePane" style="display:none;margin-top:8px">
          <div class="row">
            <div>
              <label for="resArquivo">Arquivo</label>
              <input id="resArquivo" type="file" accept=".txt,.csv" />
            </div>
            <div>
              <label for="resEncoding">Encoding</label>
              <select id="resEncoding">
                <option value="utf-8" selected>UTF-8</option>
                <option value="windows-1252">Windows-1252</option>
                <option value="iso-8859-1">ISO-8859-1</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="resMultiPane" style="display:none;margin-top:8px">
        <div class="row">
          <div>
            <label for="resMultiArquivo">Arquivo CSV</label>
            <input id="resMultiArquivo" type="file" accept=".csv,.txt" />
          </div>
          <div>
            <label for="resMultiEncoding">Encoding</label>
            <select id="resMultiEncoding">
              <option value="utf-8" selected>UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>
        </div>
        <div class="hint">Formato esperado: Primeira linha com nomes nas colunas pares (B, D, F...), linhas seguintes com dados (colunas ímpares = datas, colunas pares = valores)</div>
        
        <div id="resMultiConfig" style="display:none;margin-top:12px">
            
          <div id="resBatchConfigArea" style="margin-bottom:15px; padding:12px; background:#1c2533; border:1px solid #2b3545; border-radius:8px;">
            <h3 style="margin-top:0;font-size:1rem;color:#9bc1ff">Configuração em Lote (Colar Dados)</h3>
            <p class="hint">Cole aqui: <b>NomeOriginal</b> [espaço/tab] <b>Volume</b> [espaço/tab] <b>Diâmetro</b>.<br>O sistema buscará o nome na tabela abaixo e preencherá automaticamente.</p>
            <textarea id="resBatchInput" style="height:100px;font-family:monospace" placeholder="Exemplo:
R-CENTRO  1500  12.5
R-SUL     500   8,0"></textarea>
            <button id="resBtnApplyBatch" class="secondary" style="margin-top:8px;width:100%">Aplicar Configuração em Lote</button>
            <div id="resBatchMsg" style="margin-top:5px;font-size:0.85rem;color:#18c79c"></div>
          </div>
          <h3>Configurar Reservatórios</h3>
          <div class="config-table-container" style="max-height:300px;overflow:auto">
            <table class="config-table">
              <thead>
                <tr>
                  <th>Nome Original</th>
                  <th>Novo Nome</th>
                  <th>Volume Total (m³)</th>
                  <th>Diâmetro (m)</th>
                </tr>
              </thead>
              <tbody id="resMultiConfigBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="resBtnAdd">Processar e adicionar</button>
        <button id="resBtnCancelar" class="danger" disabled>Cancelar</button>
        <button id="resBtnLimpar" class="secondary">Limpar</button>
      </div>

      <div style="margin-top:10px">
        <progress id="resProg" max="100" value="0"></progress>
        <div id="resStatus" class="hint">Pronto</div>
      </div>

      <div id="resMsgs" class="messages"></div>
    </section>

    <section class="card">
      <h2>Prévia (Data e Nível)</h2>
      <div class="summary">
        <div class="kpi"><div class="title">Reservatório</div><div class="value" id="resOutNome">—</div></div>
        <div class="kpi"><div class="title">Área A (m²)</div><div class="value" id="resOutArea">—</div></div>
        <div class="kpi"><div class="title">Altura 100% (m)</div><div class="value" id="resOutAltura">—</div></div>
      </div>
      <div style="max-height:380px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:8px">
        <table>
          <thead><tr><th style="min-width:170px">Data</th><th>Nível (m)</th></tr></thead>
          <tbody id="resPreview"></tbody>
        </table>
      </div>
      <div class="hint">A prévia exibe até 2.000 linhas.</div>
    </section>
  </div>

  <div id="resResultados" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Resultados — Reservatórios (matriz Data | Dado por reservatório)</h2>
    <div id="resChips" class="chips"></div>
    <div class="right" style="margin-top:6px">
      <button id="resBtnExport" class="secondary" disabled>Exportar tudo (CSV)</button>
      <button id="resBtnClear" class="secondary" disabled>Limpar resultados</button>
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="resHead"></thead>
        <tbody id="resBody"></tbody>
      </table>
    </div>
    <div class="hint">Dica: clique no <b>×</b> de um chip para remover a coluna.</div>
  </div>

  <div id="resTratamento" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Tratamento — Reservatórios</h2>
    <div class="row">
      <div><label for="resAno">Ano</label><input id="resAno" type="number" value="2025" min="1900" max="2100" /></div>
      <div><label for="resMes">Mês</label>
        <select id="resMes"><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label for="resPasso">Passo (min)</label><input id="resPasso" type="number" value="15" min="1"/></div>
      <div><label for="resTol">Tolerância ± (min)</label><input id="resTol" type="number" value="5" min="0"/></div>
    </div>
    <div class="controls">
      <button id="resBtnTrat">Gerar grade tratada</button>
      <button id="resBtnTratExport" class="secondary" disabled>Baixar CSV (tratado)</button>
      <button id="resBtnTratClear" class="secondary">Limpar grade</button>
    </div>
    <div class="hint">Regra: nearest; &gt; tolerância → 0; valor encontrado = 0 → branco.</div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="resTratHead"></thead>
        <tbody id="resTratBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modVP" style="display:none;">
  <div class="tabs" id="vpTabs">
    <div class="tab active" data-pane="vpEntrada">Entrada</div>
    <div class="tab" data-pane="vpResultados">Resultados</div>
    <div class="tab" data-pane="vpTratamento">Tratamento</div>
  </div>

  <div id="vpEntrada" class="grid" style="margin-top:10px">
    <section class="card">
      <h2>Entrada — Vazão &amp; Pressão</h2>
      
      <div class="tabs" id="vpModoTabs">
        <div class="tab active" data-mode="single">Dado Único</div>
        <div class="tab" data-mode="multi">Múltiplos Dados (CSV)</div>
      </div>

      <div id="vpSinglePane" style="margin-top:8px">
        <div class="row">
          <div>
            <label for="vpNome">Nome do elemento</label>
            <input id="vpNome" type="text" placeholder="Ex.: Q1, P1, etc." />
          </div>
          <div>
            <label for="vpPrimeiraLinhaTitulo">Opções</label>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="vpPrimeiraLinhaTitulo" /> Primeira linha é o título
              </label>
            </div>
          </div>
        </div>

        <div class="tabs" id="vpSingleModoTabs">
          <div class="tab active" data-submode="paste">Colar dados</div>
          <div class="tab" data-submode="file">Arquivo (.txt/.csv)</div>
        </div>

        <div id="vpSinglePastePane" style="margin-top:8px">
          <label for="vpDados">Dados: <code>dd/mm/aaaa HH:MM[:SS]</code> + TAB + <code>valor</code></label>
          <textarea id="vpDados" placeholder="Exemplo:
01/08/2025 00:00    0
01/08/2025 00:01    1,2
01/08/2025 00:02    0"></textarea>
          <div class="hint">Zeros (0) são <b>válidos</b>.</div>
        </div>

        <div id="vpSingleFilePane" style="display:none;margin-top:8px">
          <div class="row">
            <div>
              <label for="vpArquivo">Arquivo</label>
              <input id="vpArquivo" type="file" accept=".txt,.csv" />
            </div>
            <div>
              <label for="vpEncoding">Encoding</label>
              <select id="vpEncoding">
                <option value="utf-8" selected>UTF-8</option>
                <option value="windows-1252">Windows-1252</option>
                <option value="iso-8859-1">ISO-8859-1</option>
              </select>
            </div>
          </div>
          <div class="hint">Dica Excel: Salvar como → CSV (separado por ponto e vírgula).</div>
        </div>
      </div>

      <div id="vpMultiPane" style="display:none;margin-top:8px">
        <div class="row">
          <div>
            <label for="vpMultiArquivo">Arquivo CSV</label>
            <input id="vpMultiArquivo" type="file" accept=".csv,.txt" />
          </div>
          <div>
            <label for="vpMultiEncoding">Encoding</label>
            <select id="vpMultiEncoding">
              <option value="utf-8" selected>UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>
        </div>
        <div class="hint">Formato esperado: Primeira linha com nomes nas colunas pares (B, D, F...), linhas seguintes com dados (colunas ímpares = datas, colunas pares = valores)</div>
        
        <div id="vpMultiConfig" style="display:none;margin-top:12px">
          <h3>Configurar Elementos</h3>
          <div class="config-table-container" style="max-height:300px;overflow:auto">
            <table class="config-table">
              <thead>
                <tr>
                  <th>Nome Original</th>
                  <th>Novo Nome</th>
                </tr>
              </thead>
              <tbody id="vpMultiConfigBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="vpBtnAdd">Processar e adicionar</button>
        <button id="vpBtnCancelar" class="danger" disabled>Cancelar</button>
        <button id="vpBtnLimpar" class="secondary">Limpar</button>
      </div>

      <div style="margin-top:10px">
        <progress id="vpProg" max="100" value="0"></progress>
        <div id="vpStatus" class="hint">Pronto</div>
      </div>

      <div id="vpMsgs" class="messages"></div>
    </section>

    <section class="card">
      <h2>Prévia (Data e Valor)</h2>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:8px">
        <table>
          <thead><tr><th style="min-width:170px">Data</th><th>Valor</th></tr></thead>
        <tbody id="vpPreview"></tbody>
        </table>
      </div>
      <div class="hint">A prévia exibe até 2.000 linhas.</div>
    </section>
  </div>

  <div id="vpResultados" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Resultados — Vazão &amp; Pressão (matriz Data | Dado por elemento)</h2>
    <div id="vpChips" class="chips"></div>
    <div class="right" style="margin-top:6px">
      <button id="vpBtnExport" class="secondary" disabled>Exportar tudo (CSV)</button>
      <button id="vpBtnClear" class="secondary" disabled>Limpar resultados</button>
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="vpHead"></thead>
        <tbody id="vpBody"></tbody>
      </table>
    </div>
    <div class="hint">Use o <b>×</b> do chip para remover uma coluna.</div>
  </div>

  <div id="vpTratamento" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Tratamento — Vazão &amp; Pressão</h2>
    <div class="row">
      <div><label for="vpAno">Ano</label><input id="vpAno" type="number" value="2025" min="1900" max="2100" /></div>
      <div><label for="vpMes">Mês</label>
        <select id="vpMes"><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label for="vpPasso">Passo (min)</label><input id="vpPasso" type="number" value="15" min="1"/></div>
      <div><label for="vpTol">Tolerância ± (min)</label><input id="vpTol" type="number" value="5" min="0"/></div>
    </div>
    <div class="controls">
      <button id="vpBtnTrat">Gerar grade tratada</button>
      <button id="vpBtnTratExport" class="secondary" disabled>Baixar CSV (tratado)</button>
      <button id="vpBtnTratClear" class="secondary">Limpar grade</button>
    </div>
    <div class="hint">
      Regra: nearest; &gt; tolerância → 0; valores 0 são mantidos.
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="vpTratHead"></thead>
        <tbody id="vpTratBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modLD" style="display:none;">
  <div class="tabs" id="ldTabs">
    <div class="tab active" data-pane="ldEntrada">Entrada</div>
    <div class="tab" data-pane="ldResultados">Resultados</div>
    <div class="tab" data-pane="ldTratamento">Tratamento</div>
  </div>

  <div id="ldEntrada" class="grid" style="margin-top:10px">
    <section class="card">
      <h2>Entrada — Liga/Desliga (0/1)</h2>
      
      <div class="tabs" id="ldModoTabs">
        <div class="tab active" data-mode="single">Dado Único</div>
        <div class="tab" data-mode="multi">Múltiplos Dados (CSV)</div>
      </div>

      <div id="ldSinglePane" style="margin-top:8px">
        <div class="row">
          <div>
            <label for="ldNome">Nome do elemento</label>
            <input id="ldNome" type="text" placeholder="Ex.: Bomba1, VálvulaA..." />
          </div>
          <div>
            <label for="ldPrimeiraLinhaTitulo">Opções</label>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="ldPrimeiraLinhaTitulo" /> Primeira linha é o título
              </label>
            </div>
          </div>
        </div>

        <div class="tabs" id="ldSingleModoTabs">
          <div class="tab active" data-submode="paste">Colar dados</div>
          <div class="tab" data-submode="file">Arquivo (.txt/.csv)</div>
        </div>

        <div id="ldSinglePastePane" style="margin-top:8px">
          <label for="ldDados">Dados: <code>dd/mm/aaaa HH:MM[:SS]</code> + TAB + <code>valor (0/1)</code></label>
          <textarea id="ldDados" placeholder="Exemplo:
01/08/2025 00:00    0
01/08/2025 00:07    1
01/08/2025 02:35    0"></textarea>
          <div class="hint">Valores são <b>coercidos</b> para 0/1 (≥0,5 → 1; &lt;0,5 → 0). O estado é mantido até a próxima troca (degrau).</div>
        </div>

        <div id="ldSingleFilePane" style="display:none;margin-top:8px">
          <div class="row">
            <div>
              <label for="ldArquivo">Arquivo</label>
              <input id="ldArquivo" type="file" accept=".txt,.csv" />
            </div>
            <div>
              <label for="ldEncoding">Encoding</label>
              <select id="ldEncoding">
                <option value="utf-8" selected>UTF-8</option>
                <option value="windows-1252">Windows-1252</option>
                <option value="iso-8859-1">ISO-8859-1</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="ldMultiPane" style="display:none;margin-top:8px">
        <div class="row">
          <div>
            <label for="ldMultiArquivo">Arquivo CSV</label>
            <input id="ldMultiArquivo" type="file" accept=".csv,.txt" />
          </div>
          <div>
            <label for="ldMultiEncoding">Encoding</label>
            <select id="ldMultiEncoding">
              <option value="utf-8" selected>UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>
        </div>
        <div class="hint">Formato esperado: Primeira linha com nomes nas colunas pares (B, D, F...), linhas seguintes com dados (colunas ímpares = datas, colunas pares = valores)</div>
        
        <div id="ldMultiConfig" style="display:none;margin-top:12px">
          <h3>Configurar Elementos</h3>
          <div class="config-table-container" style="max-height:300px;overflow:auto">
            <table class="config-table">
              <thead>
                <tr>
                  <th>Nome Original</th>
                  <th>Novo Nome</th>
                </tr>
              </thead>
              <tbody id="ldMultiConfigBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="ldBtnAdd">Processar e adicionar</button>
        <button id="ldBtnCancelar" class="danger" disabled>Cancelar</button>
        <button id="ldBtnLimpar" class="secondary">Limpar</button>
      </div>

      <div style="margin-top:10px)">
        <progress id="ldProg" max="100" value="0"></progress>
        <div id="ldStatus" class="hint">Pronto</div>
      </div>

      <div id="ldMsgs" class="messages"></div>
    </section>

    <section class="card">
      <h2>Prévia (Data e Estado)</h2>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:8px">
        <table>
          <thead><tr><th style="min-width:170px">Data</th><th>Estado (0/1)</th></tr></thead>
        <tbody id="ldPreview"></tbody>
        </table>
      </div>
      <div class="hint">A prévia exibe até 2.000 linhas.</div>
    </section>
  </div>

  <div id="ldResultados" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Resultados — Liga/Desliga (matriz Data | Estado por elemento)</h2>
    <div id="ldChips" class="chips"></div>
    <div class="right" style="margin-top:6px">
      <button id="ldBtnExport" class="secondary" disabled>Exportar tudo (CSV)</button>
      <button id="ldBtnClear" class="secondary" disabled>Limpar resultados</button>
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="ldHead"></thead>
        <tbody id="ldBody"></tbody>
      </table>
    </div>
  </div>

  <div id="ldTratamento" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Tratamento — Liga/Desliga (degrau)</h2>
    <div class="row">
      <div><label for="ldAno">Ano</label><input id="ldAno" type="number" value="2025" min="1900" max="2100" /></div>
      <div><label for="ldMes">Mês</label>
        <select id="ldMes"><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label for="ldPasso">Passo (min)</label><input id="ldPasso" type="number" value="15" min="1"/></div>
      <div><label for="ldTol">Tolerância ± (min)</label><input id="ldTol" type="number" value="5" min="0"/></div>
    </div>
    <div class="controls">
      <button id="ldBtnTrat">Gerar grade tratada</button>
      <button id="ldBtnTratExport" class="secondary" disabled>Baixar CSV (tratado)</button>
      <button id="ldBtnTratClear" class="secondary">Limpar grade</button>
    </div>
    <div class="hint">Regra: <b>degrau</b> — carrega o último estado 0/1 observado até a próxima mudança.</div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="ldTratHead"></thead>
        <tbody id="ldTratBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modGalax" style="display:none;">
  <div class="tabs" id="galaxTabs">
    <div class="tab active" data-pane="galaxEntrada">Entrada</div>
    <div class="tab" data-pane="galaxResultados">Resultados</div>
    <div class="tab" data-pane="galaxTratamento">Tratamento</div>
  </div>

  <div id="galaxEntrada" class="grid" style="margin-top:10px">
    <section class="card">
      <h2>Entrada — Dados Galax (Pressão)</h2>
      
      <div class="tabs" id="galaxModoTabs">
        <div class="tab active" data-mode="single">Dado Único</div>
        <div class="tab" data-mode="multi">Múltiplos Dados (CSV)</div>
      </div>

      <div id="galaxSinglePane" style="margin-top:8px">
        <div class="row">
          <div>
            <label for="galaxNome">Nome do elemento</label>
            <input id="galaxNome" type="text" placeholder="Ex.: Pressão1, P_EstacaoA..." />
          </div>
          <div>
            <label for="galaxPrimeiraLinhaTitulo">Opções</label>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="galaxPrimeiraLinhaTitulo" /> Primeira linha é o título
              </label>
            </div>
          </div>
        </div>

        <div class="tabs" id="galaxSingleModoTabs">
          <div class="tab active" data-submode="paste">Colar dados</div>
          <div class="tab" data-submode="file">Arquivo (.txt/.csv)</div>
        </div>

        <div id="galaxSinglePastePane" style="margin-top:8px">
          <label for="galaxDados">Dados: <code>dd/mm/aaaa HH:MM - valor</code></label>
          <textarea id="galaxDados" placeholder="Exemplo:
ID: FFF0F7 | 05/11/2025 08:48 - 0.000
ID: FFF0F7 | 05/11/2025 08:49 - 1.250
05/11/2025 08:50 - 2.180"></textarea>
          <div class="hint">Formato: <b>dd/mm/aaaa HH:MM - valor</b> (com ou sem ID antes)</div>
        </div>

        <div id="galaxSingleFilePane" style="display:none;margin-top:8px">
          <div class="row">
            <div>
              <label for="galaxArquivo">Arquivo</label>
              <input id="galaxArquivo" type="file" accept=".txt,.csv" />
            </div>
            <div>
              <label for="galaxEncoding">Encoding</label>
              <select id="galaxEncoding">
                <option value="utf-8" selected>UTF-8</option>
                <option value="windows-1252">Windows-1252</option>
                <option value="iso-8859-1">ISO-8859-1</option>
              </select>
            </div>
          </div>
          <div class="hint">Dica Excel: Salvar como → CSV (separado por ponto e vírgula).</div>
        </div>
      </div>

      <div id="galaxMultiPane" style="display:none;margin-top:8px">
        <div class="row">
          <div>
            <label for="galaxMultiArquivo">Arquivo CSV</label>
            <input id="galaxMultiArquivo" type="file" accept=".csv,.txt" />
          </div>
          <div>
            <label for="galaxMultiEncoding">Encoding</label>
            <select id="galaxMultiEncoding">
              <option value="utf-8" selected>UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="iso-8859-1">ISO-8859-1</option>
            </select>
          </div>
        </div>
        <div class="hint">Formato esperado: Primeira linha com nomes nas colunas pares (B, D, F...), linhas seguintes com dados (colunas ímpares = datas, colunas pares = valores)</div>
        
        <div id="galaxMultiConfig" style="display:none;margin-top:12px">
          <h3>Configurar Elementos</h3>
          <div class="config-table-container" style="max-height:300px;overflow:auto">
            <table class="config-table">
              <thead>
                <tr>
                  <th>Nome Original</th>
                  <th>Novo Nome</th>
                </tr>
              </thead>
              <tbody id="galaxMultiConfigBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="galaxBtnAdd">Processar e adicionar</button>
        <button id="galaxBtnCancelar" class="danger" disabled>Cancelar</button>
        <button id="galaxBtnLimpar" class="secondary">Limpar</button>
      </div>

      <div style="margin-top:10px">
        <progress id="galaxProg" max="100" value="0"></progress>
        <div id="galaxStatus" class="hint">Pronto</div>
      </div>

      <div id="galaxMsgs" class="messages"></div>
    </section>

    <section class="card">
      <h2>Prévia (Data e Pressão)</h2>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:8px">
        <table>
          <thead><tr><th style="min-width:170px">Data</th><th>Pressão</th></tr></thead>
        <tbody id="galaxPreview"></tbody>
        </table>
      </div>
      <div class="hint">A prévia exibe até 2.000 linhas.</div>
    </section>
  </div>

  <div id="galaxResultados" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Resultados — Dados Galax (matriz Data | Pressão por elemento)</h2>
    <div id="galaxChips" class="chips"></div>
    <div class="right" style="margin-top:6px">
      <button id="galaxBtnExport" class="secondary" disabled>Exportar tudo (CSV)</button>
      <button id="galaxBtnClear" class="secondary" disabled>Limpar resultados</button>
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="galaxHead"></thead>
        <tbody id="galaxBody"></tbody>
      </table>
    </div>
    <div class="hint">Use o <b>×</b> do chip para remover uma coluna.</div>
  </div>

  <div id="galaxTratamento" class="card" style="display:none;margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Tratamento — Dados Galax</h2>
    <div class="row">
      <div><label for="galaxAno">Ano</label><input id="galaxAno" type="number" value="2025" min="1900" max="2100" /></div>
      <div><label for="galaxMes">Mês</label>
        <select id="galaxMes"><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label for="galaxPasso">Passo (min)</label><input id="galaxPasso" type="number" value="15" min="1"/></div>
      <div><label for="galaxTol">Tolerância ± (min)</label><input id="galaxTol" type="number" value="5" min="0"/></div>
    </div>
    <div class="controls">
      <button id="galaxBtnTrat">Gerar grade tratada</button>
      <button id="galaxBtnTratExport" class="secondary" disabled>Baixar CSV (tratado)</button>
      <button id="galaxBtnTratClear" class="secondary">Limpar grade</button>
    </div>
    <div class="hint">
      Regra: nearest; &gt; tolerância → 0; valores 0 são mantidos.
    </div>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="galaxTratHead"></thead>
        <tbody id="galaxTratBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modCOI" style="display:none;">
  <div class="card" style="margin-top:10px;max-width:1200px;margin:0 auto">
    <h2>Dados COI scada — Consolidação (Reservatórios + Vazão &amp; Pressão + Liga/Desliga + Dados Galax)</h2>

    <div class="row">
      <div><label for="coiAno">Ano</label><input id="coiAno" type="number" value="2025" min="1900" max="2100"/></div>
      <div><label for="coiMes">Mês</label>
        <select id="coiMes"><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option></select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label for="coiDiaIni">Dia início</label><input id="coiDiaIni" type="number" value="1" min="1" /></div>
      <div><label for="coiDiaFim">Dia fim</label><input id="coiDiaFim" type="number" value="31" min="1" /></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label for="coiPasso">Passo (min)</label><input id="coiPasso" type="number" value="15" min="1"/></div>
      <div><label for="coiTol">Tolerância ± (min)</label><input id="coiTol" type="number" value="5" min="0"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Fontes incluídas</label>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="coiIncluiRes" checked/>Reservatórios</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="coiIncluiVP" checked/>Vazão &amp; Pressão</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="coiIncluiLD" checked/>Liga/Desliga</label>
          <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="coiIncluiGalax" checked/>Dados Galax</label>
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:10px">
      <button id="coiBtnGerar">Gerar &amp; pré-visualizar</button>
      <button id="coiBtnExport" class="secondary" disabled>Baixar CSV (COI)</button>
      <button id="coiBtnExportXls" class="secondary" disabled>Baixar Excel (.xls)</button> <button id="coiBtnClear" class="secondary">Limpar</button>
    </div>

    <div class="hint">
      Consolida: <b>Data</b> + colunas de cada módulo. Regras — Reservatórios: nearest (0→branco); Vazão &amp; Pressão: nearest (0 mantido); Liga/Desliga: <b>degrau</b> 0/1; Dados Galax: nearest (0 mantido).
    </div>

    <div style="max-height:460px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px">
      <table>
        <thead id="coiHead"></thead>
        <tbody id="coiBody"></tbody>
      </table>
    </div>
    <div class="hint">Prévia até 500 linhas.</div>
  </div>
</div>

<footer style="display:flex;flex-direction:column;gap:6px;align-items:center">
  <div>HydroResolve — h = V / [π·(D/2)²] • V(%) = (%/100)·V<sub>total</sub></div>
  <div style="color:#9fc1ff">Desenvolvido por <b>Kelvin Zeferino de Souza</b></div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function(){

  /* ===== UTILIDADES ===== */
  function two(n){ return String(n).padStart(2,'0'); }
  const nfBR3=new Intl.NumberFormat('pt-BR',{minimumFractionDigits:0,maximumFractionDigits:3});
  function formatPtBR(dt){ return `${two(dt.getDate())}/${two(dt.getMonth()+1)}/${dt.getFullYear()} ${two(dt.getHours())}:${two(dt.getMinutes())}`; }
  function parsePtBRDateTime(s){ const m=String(s).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/); if(!m) return NaN; const[_,dd,MM,yyyy,HH,mm,ss]=m; return new Date(+yyyy,+MM-1,+dd,+HH,+mm,ss?+ss:0,0).getTime(); }
  function daysInMonth(y,m1){ return new Date(y,m1,0).getDate(); }
  function gerarGradeIntervalo(y,m1,stepMin,d0,d1){ const out=[]; const max=daysInMonth(y,m1); const a=Math.max(1,Math.min(max,d0|0||1)); const b=Math.max(1,Math.min(max,d1|0||max)); let t=new Date(y,m1-1,Math.min(a,b),0,0,0,0).getTime(); const end=new Date(y,m1-1,Math.max(a,b),23,59,59,999).getTime(); const step=Math.max(1,stepMin|0)*60000; while(t<=end){ const dt=new Date(t); out.push({t,label:formatPtBR(dt)}); t+=step; } return out; }
  function nearestIndex(times,target){ let lo=0,hi=times.length-1; if(hi<0) return -1; if(target<=times[0]) return 0; if(target>=times[hi]) return hi; while(lo<=hi){ const mid=(lo+hi)>>1; if(times[mid]===target) return mid; if(times[mid]<target) lo=mid+1; else hi=mid-1; } const d1=Math.abs(times[lo]-target), d2=Math.abs(times[hi]-target); return d1<d2?lo:hi; }
  function sanitizeValueStr(s){ if(s==null) return ''; s=String(s).trim(); if((s.startsWith('"')&&s.endsWith('"'))||(s.startsWith("'")&&s.endsWith("'"))) s=s.slice(1,-1); s=s.replace(/\([^()]*\)\s*$/g,'').trim(); return s; }
  function toNumber(str){ if(str==null) return NaN; let s=sanitizeValueStr(str); if(!s) return NaN; if(s.includes(',')&&s.includes('.')) s=s.replace(/\./g,'').replace(',', '.'); else if(s.includes(',')) s=s.replace(',', '.'); s=s.replace(/[^\d+\-.\eE]/g,''); return parseFloat(s); }
  function toBinary(v){ return v>=0.5 ? 1 : 0; }
  
  // Função para processar linha de dados padrão
  function splitDataLine(line){
    const L=line.replace(/\u0000/g,'').trim(); if(!L) return null;
    let parts=L.split('\t'); if(parts.length>=2){ const left=parts.slice(0,-1).join('\t').trim(); const right=parts.at(-1).trim(); if(left && right==='') return {dt:left,valStr:null,empty:true}; if(left&&right) return {dt:left,valStr:right}; }
    for(const sep of [';','|',',']){ parts=L.split(sep); if(parts.length>=2){ const left=parts.slice(0,-1).join(sep).trim(); const right=parts.at(-1).trim(); if(left && right==='') return {dt:left,valStr:null,empty:true}; if(left&&right) return {dt:left,valStr:right}; } }
    const m=L.match(/^(.+?\d{2}:\d{2}(?::\d{2})?)\s*(.*)$/); if(m){ const dt=m[1].trim(); const right=m[2].trim(); if(!right) return {dt,valStr:null,empty:true}; return {dt,valStr:right}; }
    return null;
  }
  
  // Função específica para dados Galax (ATUALIZADA)
  // Aceita: "dd/mm/aaaa HH:MM - valor" OU "ID: xxx | dd/mm/aaaa HH:MM - valor"
  function splitGalaxDataLine(line){
    const L=line.replace(/\u0000/g,'').trim(); if(!L) return null;
    
    // Regex ajustada: removemos o ^ do início para permitir texto antes da data
    // Captura Grupo 1: Data/Hora
    // Captura Grupo 2: Valor (após o hífen)
    const m=L.match(/(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2})\s*-\s*(.*)$/);
    
    if(m){ 
      const dt=m[1].trim(); 
      const right=m[2].trim(); 
      if(!right) return {dt,valStr:null,empty:true}; 
      return {dt,valStr:right}; 
    }
    return null;
  }
  
  // Função para processar CSV com múltiplas colunas (FORMATO ATUALIZADO)
  function parseMultiColumnCSV(text, separator = ';') {
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    if (lines.length < 2) return null;
    
    // Processa cabeçalho - colunas pares contêm os nomes
    const headerLine = lines[0].split(separator);
    const columns = [];
    
    for (let i = 1; i < headerLine.length; i += 2) {
      if (i < headerLine.length) {
        const name = headerLine[i].trim();
        if (name) {
          columns.push({
            originalName: name,
            name: name,
            data: []
          });
        }
      }
    }
    
    if (columns.length === 0) return null;
    
    // Processa linhas de dados
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].split(separator);
      
      for (let j = 0; j < columns.length; j++) {
        const dataIndex = j * 2;        // Coluna ímpar (0, 2, 4...) - data
        const valueIndex = j * 2 + 1;   // Coluna par (1, 3, 5...) - valor
        
        if (dataIndex < line.length && valueIndex < line.length) {
          const dt = line[dataIndex].trim();
          const valStr = line[valueIndex].trim();
          
          if (dt && valStr) {
            const t = parsePtBRDateTime(dt);
            if (!isNaN(t)) {
              const value = toNumber(valStr);
              if (isFinite(value)) {
                columns[j].data.push({ dt, value, t });
              }
            }
          }
        }
      }
    }
    
    return columns;
  }
  
  function chipsWithRemove(container,datasets,onRemove){
    container.innerHTML='';
    datasets.forEach((ds,idx)=>{
      const pill=document.createElement('div'); pill.className='pill';
      const b=document.createElement('b'); b.textContent=ds.name;
      const info=document.createElement('span'); info.textContent=` (${ds.count.toLocaleString('pt-BR')} pts)`;
      const btn=document.createElement('button'); btn.textContent='×'; btn.title=`Remover ${ds.name}`;
      btn.onclick=()=>{ if(confirm(`Remover a coluna "${ds.name}"?`)) onRemove(idx); };
      pill.appendChild(b); pill.appendChild(info); pill.appendChild(btn);
      container.appendChild(pill);
    });
  }
  
  function renderMatrizPreview(head,body,datasets){
    head.innerHTML=''; body.innerHTML='';
    if(!datasets.length) return;
    const tr1=document.createElement('tr'), tr2=document.createElement('tr');
    datasets.forEach(ds=>{
      const th1=document.createElement('th'); th1.textContent=ds.name; tr1.appendChild(th1);
      const th1b=document.createElement('th'); th1b.textContent=ds.name; tr1.appendChild(th1b);
      const th2a=document.createElement('th'); th2a.textContent='data'; tr2.appendChild(th2a);
      const th2b=document.createElement('th'); th2b.textContent='Dado'; tr2.appendChild(th2b);
    });
    head.appendChild(tr1); head.appendChild(tr2);
    const N=Math.min(Math.max(...datasets.map(d=>d.rows.length)),200);
    const frag=document.createDocumentFragment();
    for(let i=0;i<N;i++){
      const tr=document.createElement('tr');
      datasets.forEach(ds=>{
        const r=ds.rows[i];
        const td1=document.createElement('td'); td1.textContent=r?r.dt:''; tr.appendChild(td1);
        const td2=document.createElement('td'); td2.textContent=r?nfBR3.format(r.value):''; tr.appendChild(td2);
      });
      frag.appendChild(tr);
    }
    body.appendChild(frag);
  }
  
  function exportMatrizCSV(datasets,filename){
    if(!datasets.length) return;
    const L1=[],L2=[]; datasets.forEach(ds=>{ L1.push(ds.name,ds.name); L2.push('data','Dado'); });
    const lines=[L1.join(';'),L2.join(';')];
    const maxLen=Math.max(...datasets.map(d=>d.rows.length));
    for(let i=0;i<maxLen;i++){
      const row=[];
      datasets.forEach(ds=>{
        const r=ds.rows[i];
        if(r){ row.push(r.dt, nfBR3.format(r.value)); } else { row.push('',''); }
      });
      lines.push(row.join(';'));
    }
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  /* ===== XLS (SpreadsheetML 2003) — para Excel ===== */
  function xmlEscape(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;'); }
  function buildSpreadsheetML(sheetName, matrix){
    const header = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
          xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
  <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
    <Author>HydroResolve</Author><Company>HydroResolve</Company>
  </DocumentProperties>
  <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
    <ProtectStructure>False</ProtectStructure><ProtectWindows>False</ProtectWindows>
  </ExcelWorkbook>
  <Worksheet ss:Name="${xmlEscape(sheetName||'Planilha')}">
    <Table>`;
    const rowsXml = matrix.map(row=>{
      const cells = row.map(v=>`<Cell><Data ss:Type="String">${xmlEscape(String(v==null?'':v))}</Data></Cell>`).join('');
      return `<Row>${cells}</Row>`;
    }).join('');
    const footer = `</Table></Worksheet></Workbook>`;
    return header + rowsXml + footer;
  }
  function downloadXlsFromMatrix(sheetName, matrix, filename){
    const xml = buildSpreadsheetML(sheetName, matrix);
    const blob = new Blob([xml], {type:'application/vnd.ms-excel;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename||'dados.xls';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  /* ===== Tabs MÓDULOS ===== */
  const modTabs=document.querySelectorAll('#modTabs .tab');
  const modRes=document.getElementById('modRes');
  const modVP=document.getElementById('modVP');
  const modLD=document.getElementById('modLD');
  const modGalax=document.getElementById('modGalax');
  const modCOI=document.getElementById('modCOI');
  modTabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      modTabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const m=t.dataset.mod;
      modRes.style.display = (m==='res')?'block':'none';
      modVP.style.display  = (m==='vp') ?'block':'none';
      modLD.style.display  = (m==='ld') ?'block':'none';
      modGalax.style.display = (m==='galax')?'block':'none';
      modCOI.style.display = (m==='coi')?'block':'none';
    });
  });

  /* ===== Projeto ===== */
  const projSave=document.getElementById('projSave'), projLoad=document.getElementById('projLoad'), projClear=document.getElementById('projClear'), projFile=document.getElementById('projFile'), projStatus=document.getElementById('projStatus');
  const DS_RES=[], DS_VP=[], DS_LD=[], DS_GALAX=[];
  function refreshRES(){ chipsWithRemove(document.getElementById('resChips'),DS_RES,(idx)=>{ DS_RES.splice(idx,1); refreshRES(); }); renderMatrizPreview(document.getElementById('resHead'),document.getElementById('resBody'),DS_RES); document.getElementById('resBtnExport').disabled=!DS_RES.length; document.getElementById('resBtnClear').disabled=!DS_RES.length; }
  function refreshVP(){  chipsWithRemove(document.getElementById('vpChips'),DS_VP,(idx)=>{ DS_VP.splice(idx,1); refreshVP(); }); renderMatrizPreview(document.getElementById('vpHead'),document.getElementById('vpBody'),DS_VP); document.getElementById('vpBtnExport').disabled=!DS_VP.length; document.getElementById('vpBtnClear').disabled=!DS_VP.length; }
  function refreshLD(){  chipsWithRemove(document.getElementById('ldChips'),DS_LD,(idx)=>{ DS_LD.splice(idx,1); refreshLD(); }); renderMatrizPreview(document.getElementById('ldHead'),document.getElementById('ldBody'),DS_LD); document.getElementById('ldBtnExport').disabled=!DS_LD.length; document.getElementById('ldBtnClear').disabled=!DS_LD.length; }
  function refreshGalax(){  chipsWithRemove(document.getElementById('galaxChips'),DS_GALAX,(idx)=>{ DS_GALAX.splice(idx,1); refreshGalax(); }); renderMatrizPreview(document.getElementById('galaxHead'),document.getElementById('galaxBody'),DS_GALAX); document.getElementById('galaxBtnExport').disabled=!DS_GALAX.length; document.getElementById('galaxBtnClear').disabled=!DS_GALAX.length; }

  function buildProject(){
    return {
      schema:'HydroResolveProject',version:'1.4.0',generatedAt:new Date().toISOString(),
      res:{datasets:DS_RES.map(ds=>({name:ds.name,count:ds.count,rows:ds.rows}))},
      vp :{datasets:DS_VP .map(ds=>({name:ds.name,count:ds.count,rows:ds.rows}))},
      ld :{datasets:DS_LD .map(ds=>({name:ds.name,count:ds.count,rows:ds.rows}))},
      galax:{datasets:DS_GALAX.map(ds=>({name:ds.name,count:ds.count,rows:ds.rows}))}
    };
  }
  projSave.onclick=()=>{ const json=JSON.stringify(buildProject()); const blob=new Blob([json],{type:'application/json'}); const ts=new Date(); const name=`hydroresolve_projeto_${ts.getFullYear()}${two(ts.getMonth()+1)}${two(ts.getDate())}_${two(ts.getHours())}${two(ts.getMinutes())}.json`; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); projStatus.textContent='Projeto salvo.'; setTimeout(()=>projStatus.textContent='',3000); };
  projLoad.onclick=()=>{ projFile.value=''; projFile.click(); };
  projFile.onchange=()=>{ const f=projFile.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(!o||o.schema!=='HydroResolveProject') throw new Error('Arquivo inválido'); const replace=confirm('Substituir os resultados atuais? (OK=Substituir, Cancelar=Mesclar)'); if(replace){ DS_RES.length=0; DS_VP.length=0; DS_LD.length=0; DS_GALAX.length=0; } (o.res?.datasets||[]).forEach(ds=>DS_RES.push({name:ds.name,count:ds.count??(ds.rows?.length||0),rows:ds.rows||[]})); (o.vp ?.datasets||[]).forEach(ds=>DS_VP .push({name:ds.name,count:ds.count??(ds.rows?.length||0),rows:ds.rows||[]})); (o.ld ?.datasets||[]).forEach(ds=>DS_LD .push({name:ds.name,count:ds.count??(ds.rows?.length||0),rows:ds.rows||[]})); (o.galax?.datasets||[]).forEach(ds=>DS_GALAX.push({name:ds.name,count:ds.count??(ds.rows?.length||0),rows:ds.rows||[]})); refreshRES(); refreshVP(); refreshLD(); refreshGalax(); projStatus.textContent=replace?'Projeto carregado (substituído).':'Projeto carregado (mesclado).'; setTimeout(()=>projStatus.textContent='',4000); }catch(e){ alert('Falha ao ler o projeto: '+e.message); } }; r.readAsText(f); };
  projClear.onclick=()=>{ if(!confirm('Limpar TODOS os resultados (Res/VP/LD/Galax)?')) return; DS_RES.length=0; DS_VP.length=0; DS_LD.length=0; DS_GALAX.length=0; refreshRES(); refreshVP(); refreshLD(); refreshGalax(); projStatus.textContent='Tudo limpo.'; setTimeout(()=>projStatus.textContent='',3000); };

  /* ===== SISTEMA DE MÚLTIPLOS DADOS (ATUALIZADO PARA LOTE) ===== */
  function setupMultiDataSystem(modulePrefix, datasetsArray, refreshFunction, isReservoir = false) {
    const modeTabs = document.querySelectorAll(`#${modulePrefix}ModoTabs .tab`);
    const singlePane = document.getElementById(`${modulePrefix}SinglePane`);
    const multiPane = document.getElementById(`${modulePrefix}MultiPane`);
    const multiConfig = document.getElementById(`${modulePrefix}MultiConfig`);
    const multiConfigBody = document.getElementById(`${modulePrefix}MultiConfigBody`);
    const multiArquivo = document.getElementById(`${modulePrefix}MultiArquivo`);
    
    // Elementos novos de Lote (apenas existem se for o módulo res, mas buscamos genericamente)
    const batchArea = document.getElementById(`${modulePrefix}BatchConfigArea`);
    const batchInput = document.getElementById(`${modulePrefix}BatchInput`);
    const btnApplyBatch = document.getElementById(`${modulePrefix}BtnApplyBatch`);
    const batchMsg = document.getElementById(`${modulePrefix}BatchMsg`);

    // Esconde a área de lote se não for reservatório (caso tenha copiado o HTML para outros módulos sem querer)
    if(batchArea && !isReservoir) batchArea.style.display = 'none';

    let currentMultiData = null;
    let inputsRef = []; // Para guardar referência aos inputs DOM criados

    // Alternar entre modos
    modeTabs.forEach(t => {
      t.addEventListener('click', () => {
        modeTabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const mode = t.dataset.mode;
        singlePane.style.display = (mode === 'single') ? 'block' : 'none';
        multiPane.style.display = (mode === 'multi') ? 'block' : 'none';
        multiConfig.style.display = 'none';
        currentMultiData = null;
        inputsRef = [];
      });
    });

    // LÓGICA DE LOTE (BATCH) - Só roda se os elementos existirem
    if (isReservoir && btnApplyBatch && batchInput) {
      btnApplyBatch.onclick = () => {
        if (!currentMultiData) { alert('Carregue o arquivo CSV primeiro.'); return; }
        
        const text = batchInput.value;
        if (!text.trim()) { alert('Cole os dados de configuração.'); return; }

        const lines = text.split(/\r?\n/);
        let matchCount = 0;

        lines.forEach(line => {
          const l = line.trim();
          if(!l) return;
          // Divide por espaço ou tabulação
          const parts = l.split(/\s+/);
          
          // Espera-se: NOME VOL DIAM (pelo menos 3 partes, ou nome composto)
          // Vamos assumir que as duas últimas partes são Diam e Vol, e o resto é nome
          if(parts.length >= 3) {
            const diamStr = parts.pop(); // Último é diam
            const volStr = parts.pop();  // Penúltimo é vol
            const nomeChave = parts.join(' ').trim(); // O resto é o nome
            
            // Tenta encontrar na lista atual (comparando Nome Original ou Novo Nome)
            // Normaliza strings para comparação (upper case)
            const target = currentMultiData.findIndex(c => 
              c.originalName.toUpperCase() === nomeChave.toUpperCase() || 
              c.name.toUpperCase() === nomeChave.toUpperCase()
            );

            if(target !== -1) {
              // Atualiza dados na memória
              const v = toNumber(volStr);
              const d = toNumber(diamStr);
              
              if(isFinite(v) && isFinite(d)) {
                currentMultiData[target].volume = v;
                currentMultiData[target].diameter = d;
                
                // Atualiza visualmente os inputs na tabela HTML
                if(inputsRef[target]) {
                  inputsRef[target].volInput.value = v;
                  inputsRef[target].diamInput.value = d;
                  // Piscar visual para confirmar
                  inputsRef[target].volInput.style.backgroundColor = '#1d3b2e';
                  inputsRef[target].diamInput.style.backgroundColor = '#1d3b2e';
                }
                matchCount++;
              }
            }
          }
        });
        
        batchMsg.textContent = `${matchCount} reservatórios configurados automaticamente.`;
        setTimeout(() => batchMsg.textContent = '', 5000);
      };
    }

    // Processar arquivo multi quando selecionado
    multiArquivo.onchange = () => {
      const file = multiArquivo.files?.[0];
      if (!file) return;

      const fr = new FileReader();
      fr.onload = () => {
        try {
          const text = fr.result;
          const encoding = document.getElementById(`${modulePrefix}MultiEncoding`).value;
          const decodedText = new TextDecoder(encoding).decode(new TextEncoder().encode(text));
          
          currentMultiData = parseMultiColumnCSV(decodedText);
          if (!currentMultiData || currentMultiData.length === 0) {
            alert('Não foi possível identificar colunas no formato esperado.');
            return;
          }

          // Mostrar configuração
          multiConfigBody.innerHTML = '';
          inputsRef = []; // Limpa referências

          currentMultiData.forEach((col, index) => {
            const tr = document.createElement('tr');
            
            const tdOriginal = document.createElement('td');
            tdOriginal.textContent = col.originalName;
            
            const tdNewName = document.createElement('td');
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = col.name;
            nameInput.onchange = () => currentMultiData[index].name = nameInput.value;
            tdNewName.appendChild(nameInput);
            
            const tdVol = document.createElement('td');
            const tdDiam = document.createElement('td');
            
            let vInput = null, dInput = null;

            if (isReservoir) {
              // Para reservatórios, adicionar campos de volume e diâmetro
              const volInput = document.createElement('input');
              volInput.type = 'text';
              volInput.placeholder = 'Ex.: 1250,5';
              volInput.onchange = () => currentMultiData[index].volume = toNumber(volInput.value);
              tdVol.appendChild(volInput);
              vInput = volInput;
              
              const diamInput = document.createElement('input');
              diamInput.type = 'text';
              diamInput.placeholder = 'Ex.: 12,0';
              diamInput.onchange = () => currentMultiData[index].diameter = toNumber(diamInput.value);
              tdDiam.appendChild(diamInput);
              dInput = diamInput;
            } else {
              tdVol.textContent = '-';
              tdDiam.textContent = '-';
            }
            
            tr.appendChild(tdOriginal);
            tr.appendChild(tdNewName);
            tr.appendChild(tdVol);
            tr.appendChild(tdDiam);
            
            multiConfigBody.appendChild(tr);

            // Salva referências para atualização em lote
            inputsRef.push({ volInput: vInput, diamInput: dInput });
          });
          
          multiConfig.style.display = 'block';
        } catch (e) {
          alert('Erro ao processar arquivo: ' + e.message);
        }
      };
      fr.readAsText(file);
    };

    // Retornar função para processar multi dados (Botão Processar e Adicionar)
    return function processMultiData() {
      if (!currentMultiData) {
        alert('Primeiro selecione e configure um arquivo CSV.');
        return false;
      }

      // Validar configurações
      for (const col of currentMultiData) {
        if (!col.name.trim()) {
          alert('Todos os elementos devem ter um nome.');
          return false;
        }
        if (isReservoir && (!isFinite(col.volume) || col.volume <= 0 || !isFinite(col.diameter) || col.diameter <= 0)) {
          alert(`Configure volume e diâmetro válidos para ${col.name}`);
          return false;
        }
      }

      // Processar cada coluna
      currentMultiData.forEach(col => {
        let rows = col.data;
        
        if (isReservoir) {
          // Para reservatórios, converter % para nível
          const area = Math.PI * Math.pow(col.diameter / 2, 2);
          rows = col.data.map(item => {
            const nivel = (item.value / 100) * col.volume / area;
            return { ...item, value: nivel };
          });
        }
        
        rows.sort((a, b) => (a.t || 0) - (b.t || 0));
        
        datasetsArray.push({
          name: col.name,
          rows: rows,
          count: rows.length
        });
      });

      refreshFunction();
      return true;
    };
  }

  /* ===== RESERVATÓRIOS ===== */
  (function(){
    const tabs=document.querySelectorAll('#resTabs .tab');
    const pEntrada=document.getElementById('resEntrada');
    const pResultados=document.getElementById('resResultados');
    const pTratamento=document.getElementById('resTratamento');
    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const p=t.dataset.pane; pEntrada.style.display=(p==='resEntrada')?'block':'none'; pResultados.style.display=(p==='resResultados')?'block':'none'; pTratamento.style.display=(p==='resTratamento')?'block':'none'; }));

    // Configurar sistema de múltiplos dados para reservatórios
    const processMultiRes = setupMultiDataSystem('res', DS_RES, refreshRES, true);
    
    // Modo único - configuração existente
    let singleMode='paste';
    const singleModeTabs=document.querySelectorAll('#resSingleModoTabs .tab');
    const singlePanePaste=document.getElementById('resSinglePastePane');
    const singlePaneFile=document.getElementById('resSingleFilePane');
    singleModeTabs.forEach(t=>t.addEventListener('click',()=>{ singleModeTabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); singleMode=t.dataset.submode; singlePanePaste.style.display=(singleMode==='paste')?'block':'none'; singlePaneFile.style.display=(singleMode==='file')?'block':'none'; }));

    const elNome=document.getElementById('resNome');
    const elVol =document.getElementById('resVol');
    const elDiam=document.getElementById('resDiam');
    const elTitle=document.getElementById('resPrimeiraLinhaTitulo');
    const elDados=document.getElementById('resDados');
    const elArquivo=document.getElementById('resArquivo');
    const elEncoding=document.getElementById('resEncoding');

    const btnAdd=document.getElementById('resBtnAdd');
    const btnLimpar=document.getElementById('resBtnLimpar');
    const btnClear=document.getElementById('resBtnClear');
    const btnExport=document.getElementById('resBtnExport');
    const prog=document.getElementById('resProg');
    const status=document.getElementById('resStatus');
    const msgs=document.getElementById('resMsgs');
    const prevBody=document.getElementById('resPreview');

    function areaSecao(d){ const r=d/2; return Math.PI*r*r; }
    function nivelPorVolume(V,d){ return V/areaSecao(d); }
    function addPrev(dt,v){ if(prevBody.children.length>=2000) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${dt}</td><td>${nfBR3.format(v)}</td>`; prevBody.appendChild(tr); }
    function clearEntrada(){ elNome.value=''; elVol.value=''; elDiam.value=''; elDados.value=''; if(elArquivo) elArquivo.value=''; elTitle.checked=false; status.textContent='Pronto'; prog.value=0; msgs.innerHTML=''; prevBody.innerHTML=''; }

    btnLimpar.onclick=clearEntrada;
    btnClear.onclick =()=>{ DS_RES.length=0; refreshRES(); };
    btnExport.onclick=()=> exportMatrizCSV(DS_RES,'reservatorios_matriz.csv');

    btnAdd.onclick=()=>{
      msgs.innerHTML=''; prog.value=0; status.textContent='Processando...'; prevBody.innerHTML='';
      
      // Verificar modo atual
      const activeMode = document.querySelector('#resModoTabs .tab.active').dataset.mode;
      
      if (activeMode === 'multi') {
        // Processar múltiplos dados
        if (processMultiRes()) {
          openResultados();
        }
        return;
      }
      
      // Modo único (código existente)
      const nome=(elNome.value.trim()||'Reservatório');
      const V=toNumber(elVol.value), D=toNumber(elDiam.value);
      if(!(isFinite(V)&&V>0&&isFinite(D)&&D>0)){ msgs.innerHTML='<div class="msg error">Informe Volume (m³) e Diâmetro (m) válidos (&gt;0).</div>'; status.textContent='Erro'; return; }
      document.getElementById('resOutNome').textContent=nome; document.getElementById('resOutArea').textContent=nfBR3.format(areaSecao(D)); document.getElementById('resOutAltura').textContent=nfBR3.format(V/areaSecao(D));

      const rows=[];
      if(singleMode==='paste'){
        const raw=elDados.value||''; if(!raw.trim()){ msgs.innerHTML='<div class="msg error">Cole os dados.</div>'; status.textContent='Aguardando dados'; return; }
        const lines=raw.split(/\r?\n/); const start=elTitle.checked?1:0;
        for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const perc=toNumber(r.valStr); if(!isFinite(perc)) continue; const nivel=nivelPorVolume((perc/100)*V,D); rows.push({dt:r.dt,value:nivel,t:parsePtBRDateTime(r.dt)}); addPrev(r.dt,nivel); }
      } else {
        const file=elArquivo.files?.[0]; if(!file){ msgs.innerHTML='<div class="msg error">Selecione um arquivo.</div>'; status.textContent='Aguardando arquivo'; return; }
        const fr=new FileReader(); fr.onload=()=>{ const text=fr.result; const lines=String(text).split(/\r?\n/); const start=elTitle.checked?1:0; for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const perc=toNumber(r.valStr); if(!isFinite(perc)) continue; const nivel=nivelPorVolume((perc/100)*V,D); rows.push({dt:r.dt,value:nivel,t:parsePtBRDateTime(r.dt)}); if(prevBody.children.length<2000) addPrev(r.dt,nivel); } finish(); }; fr.readAsText(file, elEncoding.value||'utf-8'); function finish(){ rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_RES.push({name:nome,rows,count:rows.length}); refreshRES(); openResultados(); clearEntrada(); } return;
      }
      rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_RES.push({name:nome,rows,count:rows.length}); refreshRES(); openResultados(); clearEntrada();

      function openResultados(){ document.querySelectorAll('#resTabs .tab').forEach(x=>x.classList.remove('active')); document.querySelector('#resTabs .tab[data-pane="resResultados"]').classList.add('active'); pEntrada.style.display='none'; pResultados.style.display='block'; pTratamento.style.display='none'; }
    };

    document.getElementById('resBtnTrat').onclick=()=>{
      const head=document.getElementById('resTratHead'); const body=document.getElementById('resTratBody'); head.innerHTML=''; body.innerHTML='';
      if(!DS_RES.length){ alert('Adicione ao menos um reservatório.'); return; }
      const Y=+document.getElementById('resAno').value||2025, M=+document.getElementById('resMes').value||1, STEP=Math.max(1,+document.getElementById('resPasso').value||15), TOL=Math.max(0,+document.getElementById('resTol').value||5);
      const grid=gerarGradeIntervalo(Y,M,STEP,1,daysInMonth(Y,M));
      const prep=DS_RES.map(ds=>{ const times=ds.rows.map(r=> r.t ?? parsePtBRDateTime(r.dt)).filter(v=>!isNaN(v)); const vals=ds.rows.map(r=>r.value); const idx=times.map((t,i)=>i).sort((a,b)=>times[a]-times[b]); return {name:ds.name,times:idx.map(i=>times[i]),vals:idx.map(i=>vals[i])}; });

      const tr=document.createElement('tr'); tr.innerHTML=['Data',...prep.map(p=>p.name)].map(h=>`<th>${h}</th>`).join(''); head.appendChild(tr);
      const lines=[['Data',...prep.map(p=>p.name)].join(';')]; const frag=document.createDocumentFragment(); const PREV=500;

      for(let i=0;i<grid.length;i++){
        const row=[];
        for(const p of prep){
          if(!p.times.length){ row.push(''); continue; }
          const k=nearestIndex(p.times,grid[i].t); const dmin=Math.abs(p.times[k]-grid[i].t)/60000;
          if(dmin>TOL) row.push('0'); else { const v=p.vals[k]; row.push(v===0?'':nfBR3.format(v)); }
        }
        lines.push([grid[i].label,...row].join(';'));
        if(i<PREV){ const trb=document.createElement('tr'); trb.innerHTML=[`<td>${grid[i].label}</td>`,...row.map(c=>`<td>${c}</td>`)].join(''); frag.appendChild(trb); }
      }
      body.appendChild(frag);
      const csv=lines.join('\n'); document.getElementById('resBtnTratExport').disabled=false;
      document.getElementById('resBtnTratExport').onclick=()=>{ const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='reservatorios_tratado.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
      document.getElementById('resBtnTratClear').onclick=()=>{ head.innerHTML=''; body.innerHTML=''; document.getElementById('resBtnTratExport').disabled=true; };
    };
  })();

  /* ===== VAZÃO & PRESSÃO ===== */
  (function(){
    const tabs=document.querySelectorAll('#vpTabs .tab');
    const pEntrada=document.getElementById('vpEntrada');
    const pResultados=document.getElementById('vpResultados');
    const pTratamento=document.getElementById('vpTratamento');
    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const p=t.dataset.pane; pEntrada.style.display=(p==='vpEntrada')?'block':'none'; pResultados.style.display=(p==='vpResultados')?'block':'none'; pTratamento.style.display=(p==='vpTratamento')?'block':'none'; }));

    // Configurar sistema de múltiplos dados para VP
    const processMultiVP = setupMultiDataSystem('vp', DS_VP, refreshVP, false);
    
    // Modo único - configuração existente
    let singleMode='paste';
    const singleModeTabs=document.querySelectorAll('#vpSingleModoTabs .tab');
    const singlePanePaste=document.getElementById('vpSinglePastePane');
    const singlePaneFile=document.getElementById('vpSingleFilePane');
    singleModeTabs.forEach(t=>t.addEventListener('click',()=>{ singleModeTabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); singleMode=t.dataset.submode; singlePanePaste.style.display=(singleMode==='paste')?'block':'none'; singlePaneFile.style.display=(singleMode==='file')?'block':'none'; }));

    const elNome=document.getElementById('vpNome');
    const elTitle=document.getElementById('vpPrimeiraLinhaTitulo');
    const elDados=document.getElementById('vpDados');
    const elArquivo=document.getElementById('vpArquivo');
    const elEncoding=document.getElementById('vpEncoding');

    const btnAdd=document.getElementById('vpBtnAdd');
    const btnLimpar=document.getElementById('vpBtnLimpar');
    const btnClear=document.getElementById('vpBtnClear');
    const btnExport=document.getElementById('vpBtnExport');
    const prog=document.getElementById('vpProg');
    const status=document.getElementById('vpStatus');
    const msgs=document.getElementById('vpMsgs');
    const prevBody=document.getElementById('vpPreview');

    function addPrev(dt,v){ if(prevBody.children.length>=2000) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${dt}</td><td>${nfBR3.format(v)}</td>`; prevBody.appendChild(tr); }
    function clearEntrada(){ elNome.value=''; elDados.value=''; if(elArquivo) elArquivo.value=''; elTitle.checked=false; status.textContent='Pronto'; prog.value=0; msgs.innerHTML=''; prevBody.innerHTML=''; }

    btnLimpar.onclick=clearEntrada;
    btnClear.onclick=()=>{ DS_VP.length=0; refreshVP(); };
    btnExport.onclick=()=> exportMatrizCSV(DS_VP,'vp_matriz.csv');

    btnAdd.onclick=()=>{
      msgs.innerHTML=''; prog.value=0; status.textContent='Processando...'; prevBody.innerHTML='';
      
      // Verificar modo atual
      const activeMode = document.querySelector('#vpModoTabs .tab.active').dataset.mode;
      
      if (activeMode === 'multi') {
        // Processar múltiplos dados
        if (processMultiVP()) {
          openResultados();
        }
        return;
      }
      
      // Modo único (código existente)
      const nome=(elNome.value.trim()||'Elemento');
      const rows=[];
      if(singleMode==='paste'){
        const raw=elDados.value||''; if(!raw.trim()){ msgs.innerHTML='<div class="msg error">Cole os dados.</div>'; status.textContent='Aguardando dados'; return; }
        const lines=raw.split(/\r?\n/); const start=elTitle.checked?1:0;
        for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const v=toNumber(r.valStr); if(!isFinite(v)) continue; rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); addPrev(r.dt,v); }
      } else {
        const file=elArquivo.files?.[0]; if(!file){ msgs.innerHTML='<div class="msg error">Selecione um arquivo.</div>'; status.textContent='Aguardando arquivo'; return; }
        const fr=new FileReader(); fr.onload=()=>{ const text=fr.result; const lines=String(text).split(/\r?\n/); const start=elTitle.checked?1:0; for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const v=toNumber(r.valStr); if(!isFinite(v)) continue; rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); if(prevBody.children.length<2000) addPrev(r.dt,v); } finish(); }; fr.readAsText(file, elEncoding.value||'utf-8'); function finish(){ rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_VP.push({name:nome,rows,count:rows.length}); refreshVP(); openResultados(); clearEntrada(); } return;
      }
      rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_VP.push({name:nome,rows,count:rows.length}); refreshVP(); openResultados(); clearEntrada();

      function openResultados(){ document.querySelectorAll('#vpTabs .tab').forEach(x=>x.classList.remove('active')); document.querySelector('#vpTabs .tab[data-pane="vpResultados"]').classList.add('active'); pEntrada.style.display='none'; pResultados.style.display='block'; pTratamento.style.display='none'; }
    };

    document.getElementById('vpBtnTrat').onclick=()=>{
      const head=document.getElementById('vpTratHead'); const body=document.getElementById('vpTratBody'); head.innerHTML=''; body.innerHTML='';
      if(!DS_VP.length){ alert('Adicione ao menos um elemento.'); return; }
      const Y=+document.getElementById('vpAno').value||2025, M=+document.getElementById('vpMes').value||1, STEP=Math.max(1,+document.getElementById('vpPasso').value||15), TOL=Math.max(0,+document.getElementById('vpTol').value||5);
      const grid=gerarGradeIntervalo(Y,M,STEP,1,daysInMonth(Y,M));
      const prep=DS_VP.map(ds=>{ const times=ds.rows.map(r=> r.t ?? parsePtBRDateTime(r.dt)).filter(v=>!isNaN(v)); const vals=ds.rows.map(r=>r.value); const idx=times.map((t,i)=>i).sort((a,b)=>times[a]-times[b]); return {name:ds.name,times:idx.map(i=>times[i]),vals:idx.map(i=>vals[i])}; });

      const tr=document.createElement('tr'); tr.innerHTML=['Data',...prep.map(p=>p.name)].map(h=>`<th>${h}</th>`).join(''); head.appendChild(tr);
      const lines=[['Data',...prep.map(p=>p.name)].join(';')]; const frag=document.createDocumentFragment(); const PREV=500;
      for(let i=0;i<grid.length;i++){
        const row=[];
        for(const p of prep){
          if(!p.times.length){ row.push(''); continue; }
          const k=nearestIndex(p.times,grid[i].t); const dmin=Math.abs(p.times[k]-grid[i].t)/60000;
          row.push(dmin>TOL?'0':nfBR3.format(p.vals[k]));
        }
        lines.push([grid[i].label,...row].join(';'));
        if(i<PREV){ const trb=document.createElement('tr'); trb.innerHTML=[`<td>${grid[i].label}</td>`,...row.map(c=>`<td>${c}</td>`)].join(''); frag.appendChild(trb); }
      }
      body.appendChild(frag);
      const csv=lines.join('\n'); document.getElementById('vpBtnTratExport').disabled=false;
      document.getElementById('vpBtnTratExport').onclick=()=>{ const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='vp_tratado.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
      document.getElementById('vpBtnTratClear').onclick=()=>{ head.innerHTML=''; body.innerHTML=''; document.getElementById('vpBtnTratExport').disabled=true; };
    };
  })();

  /* ===== LIGA/DESLIGA (0/1) ===== */
  (function(){
    const tabs=document.querySelectorAll('#ldTabs .tab');
    const pEntrada=document.getElementById('ldEntrada');
    const pResultados=document.getElementById('ldResultados');
    const pTratamento=document.getElementById('ldTratamento');
    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const p=t.dataset.pane; pEntrada.style.display=(p==='ldEntrada')?'block':'none'; pResultados.style.display=(p==='ldResultados')?'block':'none'; pTratamento.style.display=(p==='ldTratamento')?'block':'none'; }));

    // Configurar sistema de múltiplos dados para LD
    const processMultiLD = setupMultiDataSystem('ld', DS_LD, refreshLD, false);
    
    // Modo único - configuração existente
    let singleMode='paste';
    const singleModeTabs=document.querySelectorAll('#ldSingleModoTabs .tab');
    const singlePanePaste=document.getElementById('ldSinglePastePane');
    const singlePaneFile=document.getElementById('ldSingleFilePane');
    singleModeTabs.forEach(t=>t.addEventListener('click',()=>{ singleModeTabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); singleMode=t.dataset.submode; singlePanePaste.style.display=(singleMode==='paste')?'block':'none'; singlePaneFile.style.display=(singleMode==='file')?'block':'none'; }));

    const elNome=document.getElementById('ldNome');
    const elTitle=document.getElementById('ldPrimeiraLinhaTitulo');
    const elDados=document.getElementById('ldDados');
    const elArquivo=document.getElementById('ldArquivo');
    const elEncoding=document.getElementById('ldEncoding');

    const btnAdd=document.getElementById('ldBtnAdd');
    const btnLimpar=document.getElementById('ldBtnLimpar');
    const btnClear=document.getElementById('ldBtnClear');
    const btnExport=document.getElementById('ldBtnExport');
    const prog=document.getElementById('ldProg');
    const status=document.getElementById('ldStatus');
    const msgs=document.getElementById('ldMsgs');
    const prevBody=document.getElementById('ldPreview');

    function addPrev(dt,v){ if(prevBody.children.length>=2000) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${dt}</td><td>${v}</td>`; prevBody.appendChild(tr); }
    function clearEntrada(){ elNome.value=''; elDados.value=''; if(elArquivo) elArquivo.value=''; elTitle.checked=false; status.textContent='Pronto'; prog.value=0; msgs.innerHTML=''; prevBody.innerHTML=''; }

    btnLimpar.onclick=clearEntrada;
    btnClear.onclick=()=>{ DS_LD.length=0; refreshLD(); };
    btnExport.onclick=()=> exportMatrizCSV(DS_LD,'ld_matriz.csv');

    btnAdd.onclick=()=>{
      msgs.innerHTML=''; prog.value=0; status.textContent='Processando...'; prevBody.innerHTML='';
      
      // Verificar modo atual
      const activeMode = document.querySelector('#ldModoTabs .tab.active').dataset.mode;
      
      if (activeMode === 'multi') {
        // Processar múltiplos dados
        if (processMultiLD()) {
          openResultados();
        }
        return;
      }
      
      // Modo único (código existente)
      const nome=(elNome.value.trim()||'Elemento');
      const rows=[];
      if(singleMode==='paste'){
        const raw=elDados.value||''; if(!raw.trim()){ msgs.innerHTML='<div class="msg error">Cole os dados.</div>'; status.textContent='Aguardando dados'; return; }
        const lines=raw.split(/\r?\n/); const start=elTitle.checked?1:0;
        for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const v=toBinary(toNumber(r.valStr)); rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); addPrev(r.dt,v); }
      } else {
        const file=elArquivo.files?.[0]; if(!file){ msgs.innerHTML='<div class="msg error">Selecione um arquivo.</div>'; status.textContent='Aguardando arquivo'; return; }
        const fr=new FileReader(); fr.onload=()=>{ const text=fr.result; const lines=String(text).split(/\r?\n/); const start=elTitle.checked?1:0; for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitDataLine(s); if(!r||r.empty) continue; const v=toBinary(toNumber(r.valStr)); rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); if(prevBody.children.length<2000) addPrev(r.dt,v); } finish(); }; fr.readAsText(file, elEncoding.value||'utf-8'); function finish(){ rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_LD.push({name:nome,rows,count:rows.length}); refreshLD(); openResultados(); clearEntrada(); } return;
      }
      rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_LD.push({name:nome,rows,count:rows.length}); refreshLD(); openResultados(); clearEntrada();
      
      function openResultados(){ document.querySelectorAll('#ldTabs .tab').forEach(x=>x.classList.remove('active')); document.querySelector('#ldTabs .tab[data-pane="ldResultados"]').classList.add('active'); pEntrada.style.display='none'; pResultados.style.display='block'; pTratamento.style.display='none'; }
    };

    document.getElementById('ldBtnTrat').onclick=()=>{
      const head=document.getElementById('ldTratHead'); const body=document.getElementById('ldTratBody'); head.innerHTML=''; body.innerHTML='';
      if(!DS_LD.length){ alert('Adicione ao menos um elemento.'); return; }
      const Y=+document.getElementById('ldAno').value||2025, M=+document.getElementById('ldMes').value||1, STEP=Math.max(1,+document.getElementById('ldPasso').value||15);
      const grid=gerarGradeIntervalo(Y,M,STEP,1,daysInMonth(Y,M));
      
      // PREPARAÇÃO DE DADOS (DEGRAU)
      const prep=DS_LD.map(ds=>{
        const times=ds.rows.map(r=> r.t ?? parsePtBRDateTime(r.dt)).filter(v=>!isNaN(v));
        const vals=ds.rows.map(r=>r.value);
        const idx=times.map((t,i)=>i).sort((a,b)=>times[a]-times[b]);
        return {
          name:ds.name,
          times:idx.map(i=>times[i]),
          vals:idx.map(i=>vals[i])
        };
      });

      const tr=document.createElement('tr'); tr.innerHTML=['Data',...prep.map(p=>p.name)].map(h=>`<th>${h}</th>`).join(''); head.appendChild(tr);
      const lines=[['Data',...prep.map(p=>p.name)].join(';')]; const frag=document.createDocumentFragment(); const PREV=500;

      // Helper 'degrau': encontra o último valor em ou antes do tempo
      function findLastState(times, vals, targetT) {
        let lastIdx = -1;
        for (let i = 0; i < times.length; i++) {
          if (times[i] <= targetT) lastIdx = i;
          else break;
        }
        return (lastIdx !== -1) ? vals[lastIdx] : 0; // Padrão 0 se nenhum
      }

      for(let i=0;i<grid.length;i++){
        const row=[];
        for(const p of prep){
          if(!p.times.length){ row.push('0'); continue; }
          // APLICA REGRA DEGRAU
          const v = findLastState(p.times, p.vals, grid[i].t);
          row.push(v);
        }
        lines.push([grid[i].label,...row].join(';'));
        if(i<PREV){ const trb=document.createElement('tr'); trb.innerHTML=[`<td>${grid[i].label}</td>`,...row.map(c=>`<td>${c}</td>`)].join(''); frag.appendChild(trb); }
      }
      body.appendChild(frag);
      const csv=lines.join('\n'); document.getElementById('ldBtnTratExport').disabled=false;
      document.getElementById('ldBtnTratExport').onclick=()=>{ const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ld_tratado.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
      document.getElementById('ldBtnTratClear').onclick=()=>{ head.innerHTML=''; body.innerHTML=''; document.getElementById('ldBtnTratExport').disabled=true; };
    };
  })();

  /* ===== DADOS GALAX ===== */
  (function(){
    const tabs=document.querySelectorAll('#galaxTabs .tab');
    const pEntrada=document.getElementById('galaxEntrada');
    const pResultados=document.getElementById('galaxResultados');
    const pTratamento=document.getElementById('galaxTratamento');
    tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); const p=t.dataset.pane; pEntrada.style.display=(p==='galaxEntrada')?'block':'none'; pResultados.style.display=(p==='galaxResultados')?'block':'none'; pTratamento.style.display=(p==='galaxTratamento')?'block':'none'; }));

    // Configurar sistema de múltiplos dados para Galax
    const processMultiGalax = setupMultiDataSystem('galax', DS_GALAX, refreshGalax, false);
    
    // Modo único - configuração existente
    let singleMode='paste';
    const singleModeTabs=document.querySelectorAll('#galaxSingleModoTabs .tab');
    const singlePanePaste=document.getElementById('galaxSinglePastePane');
    const singlePaneFile=document.getElementById('galaxSingleFilePane');
    singleModeTabs.forEach(t=>t.addEventListener('click',()=>{ singleModeTabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); singleMode=t.dataset.submode; singlePanePaste.style.display=(singleMode==='paste')?'block':'none'; singlePaneFile.style.display=(singleMode==='file')?'block':'none'; }));

    const elNome=document.getElementById('galaxNome');
    const elTitle=document.getElementById('galaxPrimeiraLinhaTitulo');
    const elDados=document.getElementById('galaxDados');
    const elArquivo=document.getElementById('galaxArquivo');
    const elEncoding=document.getElementById('galaxEncoding');

    const btnAdd=document.getElementById('galaxBtnAdd');
    const btnLimpar=document.getElementById('galaxBtnLimpar');
    const btnClear=document.getElementById('galaxBtnClear');
    const btnExport=document.getElementById('galaxBtnExport');
    const prog=document.getElementById('galaxProg');
    const status=document.getElementById('galaxStatus');
    const msgs=document.getElementById('galaxMsgs');
    const prevBody=document.getElementById('galaxPreview');

    function addPrev(dt,v){ if(prevBody.children.length>=2000) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${dt}</td><td>${nfBR3.format(v)}</td>`; prevBody.appendChild(tr); }
    function clearEntrada(){ elNome.value=''; elDados.value=''; if(elArquivo) elArquivo.value=''; elTitle.checked=false; status.textContent='Pronto'; prog.value=0; msgs.innerHTML=''; prevBody.innerHTML=''; }

    btnLimpar.onclick=clearEntrada;
    btnClear.onclick=()=>{ DS_GALAX.length=0; refreshGalax(); };
    btnExport.onclick=()=> exportMatrizCSV(DS_GALAX,'galax_matriz.csv');

    btnAdd.onclick=()=>{
      msgs.innerHTML=''; prog.value=0; status.textContent='Processando...'; prevBody.innerHTML='';
      
      // Verificar modo atual
      const activeMode = document.querySelector('#galaxModoTabs .tab.active').dataset.mode;
      
      if (activeMode === 'multi') {
        // Processar múltiplos dados
        if (processMultiGalax()) {
          openResultados();
        }
        return;
      }
      
      // Modo único (código existente)
      const nome=(elNome.value.trim()||'Elemento');
      const rows=[];
      if(singleMode==='paste'){
        const raw=elDados.value||''; if(!raw.trim()){ msgs.innerHTML='<div class="msg error">Cole os dados.</div>'; status.textContent='Aguardando dados'; return; }
        const lines=raw.split(/\r?\n/); const start=elTitle.checked?1:0;
        for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitGalaxDataLine(s); if(!r||r.empty) continue; const v=toNumber(r.valStr); if(!isFinite(v)) continue; rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); addPrev(r.dt,v); }
      } else {
        const file=elArquivo.files?.[0]; if(!file){ msgs.innerHTML='<div class="msg error">Selecione um arquivo.</div>'; status.textContent='Aguardando arquivo'; return; }
        const fr=new FileReader(); fr.onload=()=>{ const text=fr.result; const lines=String(text).split(/\r?\n/); const start=elTitle.checked?1:0; for(let i=start;i<lines.length;i++){ const s=lines[i].trim(); if(!s) continue; const r=splitGalaxDataLine(s); if(!r||r.empty) continue; const v=toNumber(r.valStr); if(!isFinite(v)) continue; rows.push({dt:r.dt,value:v,t:parsePtBRDateTime(r.dt)}); if(prevBody.children.length<2000) addPrev(r.dt,v); } finish(); }; fr.readAsText(file, elEncoding.value||'utf-8'); function finish(){ rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_GALAX.push({name:nome,rows,count:rows.length}); refreshGalax(); openResultados(); clearEntrada(); } return;
      }
      rows.sort((a,b)=>(a.t||0)-(b.t||0)); DS_GALAX.push({name:nome,rows,count:rows.length}); refreshGalax(); openResultados(); clearEntrada();

      function openResultados(){ document.querySelectorAll('#galaxTabs .tab').forEach(x=>x.classList.remove('active')); document.querySelector('#galaxTabs .tab[data-pane="galaxResultados"]').classList.add('active'); pEntrada.style.display='none'; pResultados.style.display='block'; pTratamento.style.display='none'; }
    };

    document.getElementById('galaxBtnTrat').onclick=()=>{
      const head=document.getElementById('galaxTratHead'); const body=document.getElementById('galaxTratBody'); head.innerHTML=''; body.innerHTML='';
      if(!DS_GALAX.length){ alert('Adicione ao menos um elemento.'); return; }
      const Y=+document.getElementById('galaxAno').value||2025, M=+document.getElementById('galaxMes').value||1, STEP=Math.max(1,+document.getElementById('galaxPasso').value||15), TOL=Math.max(0,+document.getElementById('galaxTol').value||5);
      const grid=gerarGradeIntervalo(Y,M,STEP,1,daysInMonth(Y,M));
      const prep=DS_GALAX.map(ds=>{ const times=ds.rows.map(r=> r.t ?? parsePtBRDateTime(r.dt)).filter(v=>!isNaN(v)); const vals=ds.rows.map(r=>r.value); const idx=times.map((t,i)=>i).sort((a,b)=>times[a]-times[b]); return {name:ds.name,times:idx.map(i=>times[i]),vals:idx.map(i=>vals[i])}; });

      const tr=document.createElement('tr'); tr.innerHTML=['Data',...prep.map(p=>p.name)].map(h=>`<th>${h}</th>`).join(''); head.appendChild(tr);
      const lines=[['Data',...prep.map(p=>p.name)].join(';')]; const frag=document.createDocumentFragment(); const PREV=500;
      for(let i=0;i<grid.length;i++){
        const row=[];
        for(const p of prep){
          if(!p.times.length){ row.push(''); continue; }
          const k=nearestIndex(p.times,grid[i].t); const dmin=Math.abs(p.times[k]-grid[i].t)/60000;
          row.push(dmin>TOL?'0':nfBR3.format(p.vals[k]));
        }
        lines.push([grid[i].label,...row].join(';'));
        if(i<PREV){ const trb=document.createElement('tr'); trb.innerHTML=[`<td>${grid[i].label}</td>`,...row.map(c=>`<td>${c}</td>`)].join(''); frag.appendChild(trb); }
      }
      body.appendChild(frag);
      const csv=lines.join('\n'); document.getElementById('galaxBtnTratExport').disabled=false;
      document.getElementById('galaxBtnTratExport').onclick=()=>{ const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='galax_tratado.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
      document.getElementById('galaxBtnTratClear').onclick=()=>{ head.innerHTML=''; body.innerHTML=''; document.getElementById('galaxBtnTratExport').disabled=true; };
    };
  })();

  /* ===== DADOS COI SCADA (CONSOLIDAÇÃO) ===== */
  (function(){
    // Armazena a matriz de dados gerada para exportação
    let coiMatrix = [];
    
    const head = document.getElementById('coiHead');
    const body = document.getElementById('coiBody');
    
    const btnGerar = document.getElementById('coiBtnGerar');
    const btnExport = document.getElementById('coiBtnExport');
    const btnExportXls = document.getElementById('coiBtnExportXls'); // Botão de Excel
    const btnClear = document.getElementById('coiBtnClear');

    // Limpa a tabela e desativa botões
    function clearCOI(){
      head.innerHTML = '';
      body.innerHTML = '';
      btnExport.disabled = true;
      btnExportXls.disabled = true;
      coiMatrix = [];
    };
    btnClear.onclick = clearCOI;

    // Helper para regra 'degrau' (Liga/Desliga)
    // Encontra o último valor (estado) em ou antes do tempo alvo
    function findLastState(times, vals, targetT) {
      let lastIdx = -1;
      // Assume que 'times' está ordenado
      for (let i = 0; i < times.length; i++) {
        if (times[i] <= targetT) {
          lastIdx = i;
        } else {
          break; 
        }
      }
      // Retorna o valor encontrado ou 0 como padrão inicial
      return (lastIdx !== -1) ? vals[lastIdx] : 0; 
    }

    // Botão principal para gerar a consolidação
    btnGerar.onclick = () => {
      clearCOI(); // Limpa resultados anteriores

      // 1. Obter parâmetros da interface
      const Y = +document.getElementById('coiAno').value || 2025;
      const M = +document.getElementById('coiMes').value || 1;
      const D0 = +document.getElementById('coiDiaIni').value || 1;
      const D1 = +document.getElementById('coiDiaFim').value || daysInMonth(Y,M); // Usa a função utilitária global
      const STEP = Math.max(1, +document.getElementById('coiPasso').value || 15);
      const TOL = Math.max(0, +document.getElementById('coiTol').value || 5);

      const incRes = document.getElementById('coiIncluiRes').checked;
      const incVP = document.getElementById('coiIncluiVP').checked;
      const incLD = document.getElementById('coiIncluiLD').checked;
      const incGalax = document.getElementById('coiIncluiGalax').checked;
      
      // 2. Gerar a grade de tempo (base)
      const grid = gerarGradeIntervalo(Y, M, STEP, D0, D1); // Usa a função utilitária global
      if (!grid.length) {
        alert('Nenhum intervalo de tempo gerado. Verifique as datas.');
        return;
      }

      const allHeaders = ['Data'];
      const datasets = []; // Armazena os datasets preparados com suas regras

      // 3. Preparar datasets de RESERVATÓRIOS (Regra: nearest; >TOL -> 0; 0 -> branco)
      if (incRes) {
        DS_RES.forEach(ds => {
          const times = ds.rows.map(r => r.t ?? parsePtBRDateTime(r.dt)).filter(v => !isNaN(v));
          const vals = ds.rows.map(r => r.value);
          const idx = times.map((t, i) => i).sort((a, b) => times[a] - times[b]);
          const sortedTimes = idx.map(i => times[i]);
          const sortedVals = idx.map(i => vals[i]);
          
          allHeaders.push(ds.name);
          datasets.push({
            getValue: (t) => {
              if (!sortedTimes.length) return '';
              const k = nearestIndex(sortedTimes, t); // Usa a função utilitária global
              const dmin = Math.abs(sortedTimes[k] - t) / 60000;
              if (dmin > TOL) return '0';
              const v = sortedVals[k];
              return (v === 0) ? '' : nfBR3.format(v); // 0 vira branco
            }
          });
        });
      }

      // 4. Preparar datasets de VAZÃO & PRESSÃO (Regra: nearest; >TOL -> 0; 0 é mantido)
      if (incVP) {
        DS_VP.forEach(ds => {
          const times = ds.rows.map(r => r.t ?? parsePtBRDateTime(r.dt)).filter(v => !isNaN(v));
          const vals = ds.rows.map(r => r.value);
          const idx = times.map((t, i) => i).sort((a, b) => times[a] - times[b]);
          const sortedTimes = idx.map(i => times[i]);
          const sortedVals = idx.map(i => vals[i]);

          allHeaders.push(ds.name);
          datasets.push({
            getValue: (t) => {
              if (!sortedTimes.length) return '';
              const k = nearestIndex(sortedTimes, t);
              const dmin = Math.abs(sortedTimes[k] - t) / 60000;
              if (dmin > TOL) return '0';
              return nfBR3.format(sortedVals[k]); // 0 é mantido
            }
          });
        });
      }
      
      // 5. Preparar datasets de LIGA/DESLIGA (Regra: degrau/step)
      if (incLD) {
        DS_LD.forEach(ds => {
          const times = ds.rows.map(r => r.t ?? parsePtBRDateTime(r.dt)).filter(v => !isNaN(v));
          const vals = ds.rows.map(r => toBinary(r.value)); // Usa a função utilitária global
          const idx = times.map((t, i) => i).sort((a, b) => times[a] - times[b]);
          const sortedTimes = idx.map(i => times[i]);
          const sortedVals = idx.map(i => vals[i]);
          
          allHeaders.push(ds.name);
          datasets.push({
            getValue: (t) => findLastState(sortedTimes, sortedVals, t) // Usa o helper local
          });
        });
      }

      // 6. Preparar datasets de DADOS GALAX (Regra: nearest; >TOL -> 0; 0 é mantido)
      if (incGalax) {
        DS_GALAX.forEach(ds => {
          const times = ds.rows.map(r => r.t ?? parsePtBRDateTime(r.dt)).filter(v => !isNaN(v));
          const vals = ds.rows.map(r => r.value);
          const idx = times.map((t, i) => i).sort((a, b) => times[a] - times[b]);
          const sortedTimes = idx.map(i => times[i]);
          const sortedVals = idx.map(i => vals[i]);

          allHeaders.push(ds.name);
          datasets.push({
            getValue: (t) => {
              if (!sortedTimes.length) return '';
              const k = nearestIndex(sortedTimes, t);
              const dmin = Math.abs(sortedTimes[k] - t) / 60000;
              if (dmin > TOL) return '0';
              return nfBR3.format(sortedVals[k]); // 0 é mantido
            }
          });
        });
      }

      if (datasets.length === 0) {
        alert('Nenhuma fonte de dados foi incluída ou processada. Adicione dados nos outros módulos primeiro.');
        return;
      }

      // 7. Construir Cabeçalho, Corpo (prévia) e Matriz de exportação
      coiMatrix = [];
      coiMatrix.push(allHeaders); // Linha 1: Cabeçalhos
      
      const trH = document.createElement('tr');
      trH.innerHTML = allHeaders.map(h => `<th>${xmlEscape(h)}</th>`).join('');
      head.appendChild(trH);
      
      const frag = document.createDocumentFragment();
      const PREV = 500; // Limite da prévia

      for (let i = 0; i < grid.length; i++) {
        const t = grid[i].t;
        const label = grid[i].label;
        const rowData = [label]; // Coluna 1: Data
        
        // Coleta dados de cada fonte
        datasets.forEach(ds => {
          rowData.push(ds.getValue(t));
        });
        
        coiMatrix.push(rowData); // Adiciona linha completa na matriz de exportação

        // Adiciona na prévia (se estiver dentro do limite)
        if (i < PREV) {
          const trB = document.createElement('tr');
          trB.innerHTML = `<td>${label}</td>` + rowData.slice(1).map(c => `<td>${c}</td>`).join('');
          frag.appendChild(trB);
        }
      }
      
      body.appendChild(frag);
      btnExport.disabled = false;
      btnExportXls.disabled = false; // Ativa o botão de Excel!
    };

    // 8. Implementar Handlers de Exportação
    btnExport.onclick = () => {
      if (!coiMatrix.length) return;
      // Converte a matriz para CSV (ponto e vírgula)
      const csv = coiMatrix.map(row => row.join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'coi_consolidado.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    };

    btnExportXls.onclick = () => {
      if (!coiMatrix.length) return;
      // Usa a função global que você já escreveu!
      downloadXlsFromMatrix('COI Consolidado', coiMatrix, 'coi_consolidado.xls');
    };
      
  })();

});
</script>
</body>
</html>